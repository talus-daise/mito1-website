<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>新しい質問を投稿 - みとい知恵袋 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../notice/notice.css">
    <style>
        .format-buttons {
            margin-bottom: 10px;
        }

        .format-buttons button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
            width: 2.5rem;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/customAlert.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../../question/"><i class="fa-solid fa-list-check"></i>みとい知恵袋</a>
            <a href="./"><i class="fa-solid fa-pen-to-square"></i>新しい質問を投稿</a>
        </p>
    </header>

    <main>
        <h1>新しい質問を投稿</h1>
        <a href="../../question/">質問一覧に戻る</a>
        <section>
            <h2>質問情報</h2>
            <form id="question-form">
                <input type="text" id="question-title" placeholder="質問のタイトル" required><br>
                <div class="format-buttons">
                    <button id="bold"><strong>B</strong></button>
                    <button id="italic"><em>I</em></button>
                    <button id="strikethrough"><s>S</s></button>
                    <button id="link"><i class="fa-solid fa-link"></i></button>
                </div>
                <textarea id="question-content" placeholder="質問の内容" required></textarea><br>
                <input type="checkbox" id="faster">
                <label for="faster">至急求む</label><br>
                <button type="submit">投稿する</button>
            </form>
            <h3>プレビュー</h3>
        </section>

        <section id="preview"></section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p><a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>

    <script type="module">
        // Supabase クライアント作成
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const pd = createClient(
            'https://mgsbwkidyxmicbacqeeh.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg'
        );

        // 最後の投稿時刻を保存する変数
        let lastPostTime = localStorage.getItem('lastPostTime') || 0;

        // 投稿処理
        async function postQuestion(event) {
            event.preventDefault();
            event.target.disabled = true;

            // ログインユーザー情報取得
            const { data: { user }, error: userError } = await pd.auth.getUser();
            if (userError || !user) {
                showCustomAlert('投稿するにはログインが必要です');
                event.target.disabled = false;
                return;
            }

            // 表示名取得（users テーブルから）
            const { data: profile, error: profileError } = await pd
                .from('users')
                .select('display_name')
                .eq('user_email', user.email)
                .single();

            const displayName = profile?.display_name || 'とある水戸一の名無し';

            const title = parseMarkdown(document.getElementById('question-title').value.trim());
            const content = parseMarkdown(document.getElementById('question-content').value.trim());
            const faster = document.getElementById('faster').checked;

            // スパム対策
            if (!title || !content) {
                showCustomAlert('すべてのフィールドを入力してください');
                event.target.disabled = false;
                return;
            }
            if (title.length < 8 || content.length < 20) {
                showCustomAlert('タイトルは8文字以上、内容は20文字以上にしてください');
                event.target.disabled = false;
                return;
            }

            const now = Date.now();
            if (now - lastPostTime < 60000) {
                showCustomAlert('短時間での連続投稿はできません。少し待ってから再度投稿してください');
                event.target.disabled = false;
                return;
            }

            isFormDirty = false;

            // 投稿内容とユーザー情報を一緒に保存
            const { error } = await pd
                .from('questions')
                .insert([{
                    title,
                    content,
                    username: displayName,
                    faster,
                    created_at: new Date(),
                    user_id: user.id,
                    user_email: user.email
                }]);

            if (error) {
                console.error('Error posting question:', error);
                showCustomAlert('質問の投稿に失敗しました');
            } else {
                showCustomAlert('質問が投稿されました');
                localStorage.setItem('lastPostTime', now);
                window.location.href = "../../question/";
            }

            event.target.disabled = false;
        }

        // フォーム送信イベント
        document.getElementById('question-form').addEventListener('submit', postQuestion);

        // 入力変更時の離脱警告
        let isFormDirty = false;
        const formElements = [
            document.getElementById('question-title'),
            document.getElementById('question-content'),
            document.getElementById('faster')
        ];

        formElements.forEach(el => {
            el.addEventListener('input', () => {
                isFormDirty = true;
            });
        });

        window.addEventListener('beforeunload', (event) => {
            if (isFormDirty) {
                event.preventDefault();
                event.returnValue = '';
            }
        });

        // --- Markdown処理・プレビュー関連 ---
        function parseMarkdown(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/~~(.*?)~~/g, '<del>$1</del>');
            const placeholders = {};
            let index = 0;
            text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m, label, url) => {
                const key = `__URL_${index++}__`;
                placeholders[key] = `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
                return key;
            });
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/\`(.*?)\`/g, (_, code) => `<code>${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code>`);
            Object.keys(placeholders).forEach(k => text = text.replace(k, placeholders[k]));
            return text;
        }

        // --- プレビュー更新 ---
        const textarea = document.getElementById("question-content");
        function insertAtCursor(textarea, before, after, selectText = "") {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.slice(start, end) || selectText;
            const newText = text.slice(0, start) + before + selected + after + text.slice(end);
            textarea.value = newText;
            textarea.focus();
            textarea.setSelectionRange(start + before.length, start + before.length + selected.length);
        }

        document.getElementById("bold").addEventListener("click", e => { e.preventDefault(); insertAtCursor(textarea, "**", "**", " "); });
        document.getElementById("italic").addEventListener("click", e => { e.preventDefault(); insertAtCursor(textarea, "*", "*", " "); });
        document.getElementById("strikethrough").addEventListener("click", e => { e.preventDefault(); insertAtCursor(textarea, "~~", "~~", " "); });
        document.getElementById("link").addEventListener("click", e => { e.preventDefault(); insertAtCursor(textarea, "[", "](URL)", "リンクテキスト"); });

        const previewArea = document.getElementById("preview");
        document.getElementById("question-form").addEventListener("keyup", async () => {
            const title = parseMarkdown(document.getElementById("question-title").value.trim());
            const content = parseMarkdown(document.getElementById("question-content").value.trim());

            // 表示名をリアルタイムで取得（キャッシュ代わり）
            const { data: { user } } = await pd.auth.getUser();
            let displayName = "とある水戸一の名無し";
            if (user) {
                const { data: profile } = await pd.from("users").select("display_name").eq("user_email", user.email).single();
                displayName = profile?.display_name || displayName;
            }

            previewArea.innerHTML = `
        <h2>${title}</h2>
        <p>質問者: ${displayName}</p>
        <p>${content}</p>
        <small>${new Date().toLocaleString()}</small>
    `;
        });

    </script>
    <script type="module" src="../../notice/notice.js"></script>
    <script src="../../script/customAlert.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
    <script src="../../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>