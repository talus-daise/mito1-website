<!DOCTYPE html>
<html lang="ja">

<head>
    <!--æ–‡å­—ã‚³ãƒ¼ãƒ‰ãƒ»äº’æ›ãƒ¢ãƒ¼ãƒ‰-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title id="page-title">ã¿ã¨ã„çŸ¥æµè¢‹ | æ°´æˆ¸ä¸€é«˜é™„å±ä¸­ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</title>
    <!--ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../notice/notice.css">
    <style>
        .format-buttons {
            margin-bottom: 10px;
        }

        .format-buttons button {
            margin-right: 5px;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
            width: 2.5rem;
        }
    </style>
    <!--webæƒ…å ±-->
    <meta name="keywords" content="æ°´æˆ¸ä¸€, æ°´æˆ¸ä¸€é™„å±, æ°´æˆ¸ä¸€é™„å±ä¸­, ä¸€å­¦å¹´,">
    <meta name="description" content="æ°´æˆ¸ä¸€é™„å±ä¸­ç”Ÿå‘ã‘ã®ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§ã™ã€‚é™„å±ä¸­å‘ã‘ã®æ²ç¤ºæ¿ã‚„è³ªå•ç®±ã‚’é‹å–¶ã—ã¦ã„ã¾ã™ã€‚">
    <meta name="author" content="Â©ï¸ 2025 talus">
    <!--æ›´æ–°æ—¥æ™‚-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--ã‚¢ã‚¤ã‚³ãƒ³-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <!--ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../../">æ°´æˆ¸ä¸€é«˜é™„å±ä¸­ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</a></h1>
        <p class="header__breadcrumb">
            <a href="../../"><i class="fa-solid fa-house"></i>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>
            <a href="../"><i class="fa-solid fa-list-check"></i>ã¿ã¨ã„çŸ¥æµè¢‹</a>
            <span id="page-link"></span>

        </p>
    </header>

    <main>
        <section>
            <h2 id="question-title"></h2>
            <small id="question-posted-at"></small> <!-- è³ªå•ã®æŠ•ç¨¿æ—¥æ™‚è¡¨ç¤º -->
            <p class="username" id="question-username"></p>
            <p id="question-content"></p>
        </section>

        <section>
            <h2>å›ç­”</h2>
            <ul id="answer-list"></ul>
            <h3>å›ç­”ã‚’æŠ•ç¨¿ã™ã‚‹</h3>
            <form id="answer-form">
                <div class="format-buttons">
                    <button id="bold" title="å¤ªå­—"><strong>B</strong></button>
                    <button id="italic" title="æ–œä½“"><em>I</em></button>
                    <button id="strikethrough" title="å–ã‚Šæ¶ˆã—ç·š"><del>S</del></button>
                    <button id="link" title="ãƒªãƒ³ã‚¯"><i class="fa-solid fa-link"></i></button>
                </div>
                <textarea id="answer-content" placeholder="å›ç­”ã®å†…å®¹" required></textarea><br>
                <button type="submit">å›ç­”</button>
            </form>

            <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div id="preview"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>â€»ã“ã®ã‚µã‚¤ãƒˆã¯å­¦æ ¡éå…¬èªã®å€‹äººãŒé‹å–¶ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒˆã§ã™ã€‚å­¦æ ¡å´ã®å•é¡Œã«è²¬ä»»ã¯å–ã‚Œã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚</p>
        <p><a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">èŒ¨åŸçœŒç«‹æ°´æˆ¸ç¬¬ä¸€é«˜ç­‰å­¦æ ¡é™„å±ä¸­å­¦æ ¡HP</a>
        </p>
    </footer>

    <script type="module">
        // Supabase ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const pd = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        const urlParams = new URLSearchParams(window.location.search);
        const questionId = urlParams.get("id");
        const answerId = urlParams.get("answer_id");

        // è³ªå•ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        async function fetchQuestion() {
            const { data: question, error } = await pd
                .from("questions")
                .select("*")
                .eq("id", questionId)
                .single();

            if (error) {
                console.error("Error fetching question:", error);
                return;
            }

            document.getElementById("question-title").innerHTML = question.title;
            document.getElementById("question-username").innerHTML = "è³ªå•è€…: " + question.username;
            document.getElementById("question-username").setAttribute("data-user-id", question.user_id);
            document.getElementById("question-content").innerHTML = question.content;

            const postDate = new Date(question.created_at).toLocaleString();
            document.getElementById("question-posted-at").textContent = `æŠ•ç¨¿æ—¥æ™‚: ${postDate}`;

            document.getElementById("page-title").textContent = `${question.title} - ã¿ã¨ã„çŸ¥æµè¢‹ | æ°´æˆ¸ä¸€é«˜é™„å±ä¸­ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ`;
            document.getElementById(
                "page-link"
            ).innerHTML = `<a href="?id=${questionId}"><i class="fa-solid fa-circle-info"></i>è³ªå•ã€Œ${question.title}ã€ã®è©³ç´°</a>`;

            fetchAnswers();
        }

        // å›ç­”ä¸€è¦§ã‚’å–å¾—
        async function fetchAnswers() {
            const { data: answers, error } = await pd
                .from("answers")
                .select("*")
                .eq("question_id", questionId)
                .order("created_at", { ascending: false });

            if (error) {
                console.error("Error fetching answers:", error);
                return;
            }

            const answerList = document.getElementById("answer-list");
            answerList.innerHTML = "";
            answers.forEach((answer) => {
                const li = document.createElement("li");
                const answerDate = new Date(answer.created_at).toLocaleString();
                li.innerHTML = `
            ${answer.content} - by <span class="username" data-user-id="${answer.user_id}">${answer.username}</span>
            <small>(${answerDate})</small>`;
                answerList.appendChild(li);
            });

            if (answerId) {
                // å¯¾è±¡ã®å›ç­”ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ã™
                const target = answers.find((a) => String(a.id) === String(answerId));
                if (target) {
                    // ãƒ†ã‚­ã‚¹ãƒˆæ¯”è¼ƒç”¨ã®HTMLé™¤å»ãƒ˜ãƒ«ãƒ‘ãƒ¼
                    const stripHtml = (s) => (s || "").replace(/<[^>]*>/g, "").replace(/\s+/g, " ").trim();
                    const expected = `${stripHtml(target.content)} - by ${target.username} (${new Date(
                        target.created_at
                    ).toLocaleString()})`;

                    // li ã‚’èµ°æŸ»ã—ã¦ä¸€è‡´ã™ã‚‹è¦ç´ ã‚’æ¢ã™
                    const items = Array.from(document.querySelectorAll("#answer-list li"));
                    const found = items.find((li) => stripHtml(li.textContent).includes(expected));

                    if (found) {
                        found.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        // ç°¡å˜ãªãƒã‚¤ãƒ©ã‚¤ãƒˆ
                        const originalBg = found.style.backgroundColor;
                        found.style.backgroundColor = '#fffbcc';
                        setTimeout(() => { found.style.transition = 'background-color 1s'; found.style.backgroundColor = originalBg || ''; }, 500);
                    }
                }
            }

            document.querySelectorAll(".username").forEach((element) => {
                element.style.cursor = 'pointer';
                element.addEventListener("click", () => {
                    const userId = element.getAttribute("data-user-id");
                    window.location.href = `/mito1-website/mypage/other/?user_id=${encodeURIComponent(userId)}`;
                });
            });
        }

        // å›ç­”æŠ•ç¨¿å‡¦ç†
        document.getElementById("answer-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            event.target.disabled = true;

            // ğŸ”’ ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
            const { data: { user }, error: userError } = await pd.auth.getUser();
            if (userError || !user) {
                showCustomAlert("å›ç­”ã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
                event.target.disabled = false;
                return;
            }

            // ğŸŒŸ è¡¨ç¤ºåã‚’å–å¾—
            let displayName = "ã¨ã‚ã‚‹æ°´æˆ¸ä¸€ã®åç„¡ã—";
            const { data: userRecord, error: userRecordError } = await pd
                .from("users")
                .select("display_name")
                .eq("user_id", user.id)
                .single();
            if (!userRecordError && userRecord && userRecord.display_name) {
                displayName = userRecord.display_name;
            }
            console.log(displayName);

            const content = parseMarkdown(document.getElementById("answer-content").value.trim());

            if (!content) {
                showCustomAlert("ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                event.target.disabled = false;
                return;
            }
            if (content.length < 20) {
                showCustomAlert("å›ç­”ã¯20æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ï¼ˆã‚¹ãƒ‘ãƒ å¯¾ç­–ã§ã™ï¼‰");
                event.target.disabled = false;
                return;
            }

            const lastAnswerTime = localStorage.getItem("lastAnswerTime") || 0;
            const now = Date.now();
            if (now - lastAnswerTime < 60000) {
                showCustomAlert("çŸ­æ™‚é–“ã§ã®é€£ç¶šæŠ•ç¨¿ã¯ã§ãã¾ã›ã‚“ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦æŠ•ç¨¿ã—ã¦ãã ã•ã„");
                event.target.disabled = false;
                return;
            }

            isFormDirty = false;

            // ğŸ’¾ å›ç­”ã‚’æŒ¿å…¥ï¼ˆuser_id, user_email, display_nameã‚‚å«ã‚€ï¼‰
            const { error } = await pd.from("answers").insert([
                {
                    question_id: questionId,
                    content,
                    username: displayName,
                    created_at: new Date(),
                    user_id: user.id,
                    user_email: user.email,
                },
            ]);

            if (error) {
                console.error("Error posting answer:", error);
                showCustomAlert("å›ç­”ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
            } else {
                showCustomAlert("å›ç­”ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ");
                localStorage.setItem("lastAnswerTime", now);
                markAsAnswered(questionId);
                fetchAnswers();
                document.getElementById("answer-content").value = "";
            }

            setTimeout(() => {
                event.target.disabled = false;
            }, 5000);
        });

        // å›ç­”æ¸ˆã¿ãƒ•ãƒ©ã‚°
        async function markAsAnswered(questionId) {
            const { error } = await pd.from("questions").update({ answered: true }).eq("id", questionId);
            if (error) console.error("å›ç­”æ¸ˆã¿ãƒ•ãƒ©ã‚°æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        }

        fetchQuestion();

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll(".username").forEach((element) => {
                element.style.cursor = 'pointer';
                element.addEventListener("click", () => {
                    const userId = element.getAttribute("data-user-id");
                    window.location.href = `/mito1-website/mypage/other/?user_id=${encodeURIComponent(userId)}`;
                });
            });
        });

        fetchQuestion();
        function parseMarkdown(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
            text = text.replace(/\*(.*?)\*/g, "<em>$1</em>");
            text = text.replace(/~~(.*?)~~/g, "<del>$1</del>");
            const placeholders = {};
            let index = 0;
            text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (m, label, url) => {
                const key = `__URL_${index++}__`;
                placeholders[key] = `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
                return key;
            });
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
            text = text.replace(/\n/g, "<br>");
            text = text.replace(/\`(.*?)\`/g, (_, code) => `<code>${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code>`);
            Object.keys(placeholders).forEach((k) => (text = text.replace(k, placeholders[k])));
            return text;
        }

        // --- å…¥åŠ›è£œåŠ© ---
        const textarea = document.getElementById("answer-content");

        function insertAtCursor(textarea, before, after, selectText = "") {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.slice(start, end) || selectText;
            const newText = text.slice(0, start) + before + selected + after + text.slice(end);
            textarea.value = newText;
            textarea.focus();
            textarea.setSelectionRange(start + before.length, start + before.length + selected.length);
        }

        document.getElementById("bold").addEventListener("click", (e) => {
            e.preventDefault();
            insertAtCursor(textarea, "**", "**", " ");
        });
        document.getElementById("italic").addEventListener("click", (e) => {
            e.preventDefault();
            insertAtCursor(textarea, "*", "*", " ");
        });
        document.getElementById("strikethrough").addEventListener("click", (e) => {
            e.preventDefault();
            insertAtCursor(textarea, "~~", "~~", " ");
        });
        document.getElementById("link").addEventListener("click", (e) => {
            e.preventDefault();
            insertAtCursor(textarea, "[", "](URL)", "ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ");
        });

        // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ---
        const previewArea = document.getElementById("preview");
        document.getElementById("answer-form").addEventListener("keyup", async (e) => {
            const { data: { session } } = await pd.auth.getSession();

            if (session && session.user) {
                const userId = session.user.id;
                const userEmail = session.user.email;

                const { data: user } = await pd
                    .from("users")
                    .select("display_name")
                    .eq("user_id", userId)
                    .single();
                const content = parseMarkdown(document.getElementById("answer-content").value.trim());
                previewArea.innerHTML = `
        <ul>
            <li>
                ${content} - by <span class="username" data-user-id="${userId}">${user.display_name}</span>
                <small>(${new Date().toLocaleString()})</small>
            </li>
        </ul>`;
            }
        });

        // --- æœªä¿å­˜è­¦å‘Š ---
        let isFormDirty = false;
        document.getElementById("answer-content").addEventListener("input", () => {
            isFormDirty = true;
        });
        window.addEventListener("beforeunload", (event) => {
            if (isFormDirty) {
                event.preventDefault();
                event.returnValue = "";
            }
        });
    </script>
    <script type="module" src="../../notice/notice.js" defer></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <!--ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ-->
    <link rel="manifest" href="../../manifest.json">
    <script src="../../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>