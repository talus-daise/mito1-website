<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title id="page-title">みとい知恵袋 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>

    <!-- Markdown + Sanitizer -->
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../"><i class="fa-solid fa-list-check"></i>みとい知恵袋</a>
            <span id="page-link"></span>
        </p>
    </header>

    <main>
        <section>
            <h2 id="question-title"></h2>
            <p class="username" id="question-username"></p>
            <p id="question-posted-at"></p>
            <div id="question-content"></div>
            <div id="control-div"></div>
            <h3>質問者からのメッセージ</h3>
            <div id="thank-message"></div>
        </section>

        <section>
            <h2>回答</h2>
            <div id="answer-list" class="content-list"></div>

            <h3>回答を投稿する</h3>
            <form id="answer-form">
                <div class="format-buttons">
                    <button id="bold" title="太字"><strong>B</strong></button>
                    <button id="italic" title="斜体"><em>I</em></button>
                    <button id="strikethrough" title="取り消し線"><del>S</del></button>
                    <button id="link" title="リンク"><i class="fa-solid fa-link"></i></button>
                </div>
                <p><textarea id="answer-content" placeholder="回答の内容" required></textarea><br></p>
                <p><button type="submit">回答</button></p>
            </form>

            <h3>プレビュー</h3>
            <div id="preview"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p><a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        // Markdown初期化
        const md = window.markdownit({
            html: false,
            linkify: true,
            breaks: true
        });

        function renderMarkdown(container, text) {
            const rawHtml = md.render(text || "");
            const safeHtml = DOMPurify.sanitize(rawHtml);
            container.innerHTML = safeHtml;
        }

        function parseMarkdown(text) {
            const rawHtml = md.render(text || "");
            return DOMPurify.sanitize(rawHtml);
        }

        async function checkCount(answerId) {
            const { data, error } = await supabase
                .from("answer_reactions")
                .select("type")
                .eq("answer_id", answerId);

            if (error) {
                console.error("リアクションの取得に失敗:", error);
                return;
            }

            const naruhodoCount = data.filter(r => r.type === "naruhodo").length;
            const arigatoCount = data.filter(r => r.type === "arigato").length;

            const { error: updateError } = await supabase
                .from("answers")
                .update({
                    naruhodo_count: naruhodoCount,
                    arigato_count: arigatoCount
                })
                .eq("id", answerId);

            if (updateError) {
                console.error("カウントの更新に失敗:", updateError);
            }

            fetchAnswers();
        }

        const urlParams = new URLSearchParams(window.location.search);
        const questionId = urlParams.get("id");
        const answerId = urlParams.get("answer_id");

        async function fetchQuestion() {
            const { data: question, error } = await supabase
                .from("questions")
                .select("*")
                .eq("id", questionId)
                .single();

            if (error) return;

            const postDate = new Date(question.created_at).toLocaleString();

            document.getElementById("question-title").textContent = question.title;

            const usernameEl = document.getElementById("question-username");
            usernameEl.innerHTML = `<i class="fa-solid fa-user"></i>${question.username}`;
            usernameEl.setAttribute("data-user-id", question.user_id);

            document.getElementById("question-posted-at").innerHTML =
                `<i class="fa-solid fa-clock"></i>${postDate}`;

            renderMarkdown(
                document.getElementById("question-content"),
                question.content
            );

            document.getElementById("page-title").textContent =
                `${question.title} - みとい知恵袋 | 水戸一高附属中総合ウェブサイト`;

            document.getElementById("page-link").innerHTML =
                `<a href="?id=${questionId}"><i class="fa-solid fa-circle-info"></i>質問「${question.title}」の詳細</a>`;

            const { data: { user } } = await supabase.auth.getUser();

            if (user && user.id === question.user_id) {
                const controlDiv = document.getElementById("control-div");

                controlDiv.innerHTML = ""; // 既存の内容をクリア

                const h3 = document.createElement("h3");
                h3.textContent = "質問管理";

                const p = document.createElement("p");
                const toggleBtn = document.createElement("button");
                toggleBtn.textContent = question.answered_stop ? "回答受付を再開" : "回答受付を停止";
                p.appendChild(toggleBtn);

                toggleBtn.addEventListener("click", async () => {
                    await supabase
                        .from("questions")
                        .update({ answered_stop: !question.answered_stop, closed_at: question.answered_stop ? null : new Date() })
                        .eq("id", questionId);

                    fetchQuestion();
                });

                controlDiv.append(document.createElement("hr"), h3, p, document.createElement("hr"));

                // 感謝メッセージ入力欄
                if (question.answered_stop) {
                    const thankH3 = document.createElement("h3");
                    thankH3.textContent = "感謝メッセージ";
                    controlDiv.appendChild(thankH3);
                    const thankP = document.createElement("p");
                    const thankInput = document.createElement("textarea");
                    thankInput.placeholder = "感謝メッセージ";
                    thankInput.value = question.thank_message || "";

                    const saveP = document.createElement("p");
                    const saveBtn = document.createElement("button");
                    saveBtn.textContent = "感謝メッセージ保存";

                    saveBtn.addEventListener("click", async () => {
                        await supabase
                            .from("questions")
                            .update({ thank_message: thankInput.value })
                            .eq("id", questionId);

                        showCustomNotification("保存しました！");
                    });

                    thankP.appendChild(thankInput);
                    saveP.appendChild(saveBtn);

                    controlDiv.appendChild(thankP);
                    controlDiv.appendChild(saveP);
                    controlDiv.appendChild(document.createElement("hr"));
                }
            }

            if (question.thank_message) {
                const thanks = document.getElementById("thank-message");
                thanks.className = "thank-message";
                renderMarkdown(thanks, question.thank_message);
            }

            fetchAnswers();
        }

        async function fetchAnswers() {
            const { data: answers, error } = await supabase
                .from("answers")
                .select("*")
                .eq("question_id", questionId)
                .order("created_at", { ascending: false });

            if (error) return;

            const answerList = document.getElementById("answer-list");
            answerList.innerHTML = "";

            answers.forEach((answer) => {
                const div = document.createElement("div");
                div.classList.add("content-list-item");

                const username = document.createElement("p");
                username.className = "username";
                username.setAttribute("data-user-id", answer.user_id);
                username.innerHTML = `<i class="fa-solid fa-user"></i>${parseMarkdown(answer.username).replace(/<p[^>]*>(.*?)<\/p>/g, "$1")}`;
                username.style.marginLeft = "0";

                const time = document.createElement("p");
                time.innerHTML =
                    `<i class="fa-solid fa-clock"></i>${new Date(answer.created_at).toLocaleString()}`;
                time.style.marginLeft = "0";

                const content = document.createElement("div");
                renderMarkdown(content, answer.content);

                div.appendChild(username);
                div.appendChild(time);
                div.appendChild(content);
                answerList.appendChild(div);

                const reactions = document.createElement("div");

                const naruhodoP = document.createElement("p");
                const naruhodoBtn = document.createElement("button");
                naruhodoBtn.textContent = `なるほど (${answer.naruhodo_count || 0})`;

                naruhodoBtn.onclick = async () => {
                    const { error } = await supabase.rpc("increment_naruhodo", {
                        answer_id_input: answer.id
                    });

                    checkCount(answer.id);

                    if (error) {
                        showCustomNotification(error.message);
                        return;
                    }

                    fetchAnswers();
                };

                naruhodoP.appendChild(naruhodoBtn);

                const arigatoP = document.createElement("p");
                const arigatoBtn = document.createElement("button");
                arigatoBtn.textContent = `ありがとう (${answer.arigato_count || 0})`;

                arigatoBtn.onclick = async () => {
                    const { error } = await supabase.rpc("increment_arigato", {
                        answer_id_input: answer.id
                    });

                    checkCount(answer.id);

                    if (error) {
                        showCustomNotification(error.message);
                        return;
                    }

                    fetchAnswers();
                };
                arigatoP.appendChild(arigatoBtn);

                reactions.appendChild(naruhodoP);
                reactions.appendChild(arigatoP);
                div.appendChild(reactions);
            });

        }

        document.getElementById("answer-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            event.target.disabled = true;

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                showCustomAlert("回答を投稿するにはログインが必要です", false);
                event.target.disabled = false;
                return;
            }

            // 質問の状態取得
            const { data: questionState } = await supabase
                .from("questions")
                .select("answered_stop")
                .eq("id", questionId)
                .single();

            if (questionState?.answered_stop) {
                showCustomNotification("この質問は回答受付を終了しています");
                event.target.disabled = false;
                return;
            }

            let displayName = "とある水戸一の名無し";
            const { data: userRecord } = await supabase
                .from("users")
                .select("display_name")
                .eq("user_id", user.id)
                .single();

            if (userRecord?.display_name) {
                displayName = userRecord.display_name;
            }

            const rawContent = document.getElementById("answer-content").value.trim();

            if (!rawContent || rawContent.length < 20) {
                showCustomNotification("回答は20文字以上にしてください");
                event.target.disabled = false;
                return;
            }

            await supabase.from("answers").insert([{
                question_id: questionId,
                content: rawContent,
                username: displayName,
                created_at: new Date(),
                user_id: user.id,
                user_email: user.email,
            }]);

            document.getElementById("answer-content").value = "";
            fetchAnswers();
            event.target.disabled = false;
        });

        // --- 入力補助 ---
        const textarea = document.getElementById("answer-content");

        function insertAtCursor(before, after, selectText = "") {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.slice(start, end) || selectText;
            textarea.value =
                text.slice(0, start) +
                before + selected + after +
                text.slice(end);
            textarea.focus();
            textarea.setSelectionRange(
                start + before.length,
                start + before.length + selected.length
            );
        }

        document.getElementById("bold").addEventListener("click", e => {
            e.preventDefault();
            insertAtCursor("**", "**", " ");
        });

        document.getElementById("italic").addEventListener("click", e => {
            e.preventDefault();
            insertAtCursor("*", "*", " ");
        });

        document.getElementById("strikethrough").addEventListener("click", e => {
            e.preventDefault();
            insertAtCursor("~~", "~~", " ");
        });

        document.getElementById("link").addEventListener("click", e => {
            e.preventDefault();
            insertAtCursor("[", "](URL)", "リンクテキスト");
        });

        // --- プレビュー ---
        const previewArea = document.getElementById("preview");

        textarea.addEventListener("input", () => {
            previewArea.innerHTML = "";
            const content = document.createElement("div");
            renderMarkdown(content, textarea.value.trim());
            previewArea.appendChild(content);
        });

        fetchQuestion();

        document.addEventListener("DOMContentLoaded", async () => {
            const { data, error } = await supabase
                .from("questions")
                .select("answered_stop, closed_at")
                .eq("id", questionId)
                .single();

            const form = document.getElementById("answer-form")
            const p = document.createElement("p");
            if (data?.answered_stop) {
                form.textContent = "";
                const time = data.closed_at ? new Date(data.closed_at).toLocaleString() : null;
                p.textContent = `この質問は${time ? time + "に" : ""}回答受付を終了しています`;
                form.appendChild(p);
            }
        });
    </script>

    <script type="module" src="../../script/notice/notice.js" defer></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>