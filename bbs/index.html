<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>掲示板 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="./"><i class="fa-solid fa-chalkboard"></i>掲示板</a>
        </p>
    </header>

    <main>
        <h1>掲示板</h1>

        <section>
            <h2>ページ概要</h2>
            <p>掲示板です。</p>
            <p>ここでは、様々なトピックについての議論や情報交換、雑談などが行われています。</p>
            <p>新しいスレッドを作成したり、既存のスレッドに投稿したりすることができます。</p>
            <p>興味のあるトピックについて気軽に投稿してください。</p>
            <p><a href="new_thread/">新規スレッド作成はここ</a></p>
        </section>

        <section class="highlight">
            <h2>スパム行為について</h2>
            <p>掲示板ではスパム行為を禁止しています。</p>
            <p>スパム行為が確認された場合、該当する投稿は削除され、投稿者はサイトへのアクセスができなくなる場合があります。</p>
        </section>

        <section>
            <h2 id="listTitle">スレ一覧</h2>
            <p>
                <label for="search-box">
                    検索：
                    <input type="text" id="search-box" placeholder="スレッドを検索...">
                </label>
                <button id="search-btn">検索</button>
            </p>
            <div id="threadList" class="content-list"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p>
            <a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">
                茨城県立水戸第一高等学校附属中学校HP
            </a>
        </p>
    </footer>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        // --- Markdown初期化 ---
        const md = window.markdownit({
            html: false,
            linkify: true,
            breaks: true
        });

        function renderMarkdown(text) {
            const raw = md.render(text || "");
            return DOMPurify.sanitize(raw);
        }

        const threadList = document.getElementById("threadList");

        async function loadCategories() {
            const { data: categories, error } = await supabase
                .from("bbs_category")
                .select("id, name")
                .order("name");

            if (error) {
                console.error(error);
                return;
            }

            threadList.innerHTML = "";

            document.getElementById("listTitle").textContent = "カテゴリ一覧";

            // 全カテゴリ表示ボタン
            const allSpan = document.createElement("span");
            allSpan.className = "content-list-item";
            const allA = document.createElement("a");
            allA.style.color = "inherit";
            const allH3 = document.createElement("h3");
            allH3.innerHTML = `全てのスレッド`;
            const { count: allCount, error: allCountError } = await supabase
                .from("bbs_thread")
                .select("*", { count: "exact", head: true });

            const allP = document.createElement("p");
            allP.innerHTML = `<i class="fa-solid fa-hashtag"></i> ${allCount || 0}件のスレッド`;
            allA.appendChild(allH3);
            allA.appendChild(allP);
            allSpan.appendChild(allA);
            allA.onclick = () => loadThreads();
            threadList.appendChild(allSpan);

            for (const category of categories) {
                const span = document.createElement("span");
                span.className = "content-list-item";

                const a = document.createElement("a");
                a.style.color = "inherit";
                a.style.cursor = "pointer";

                const h3 = document.createElement("h3");
                h3.textContent = category.name;
                a.appendChild(h3);

                const num = document.createElement("p");

                const { count, error: countError } = await supabase
                    .from("bbs_thread")
                    .select("*", { count: "exact", head: true })
                    .eq("category_id", category.id);

                if (countError) {
                    console.error(countError);
                } else {
                    num.innerHTML =
                        `<i class="fa-solid fa-hashtag"></i> ${count || 0}件のスレッド`;
                    a.appendChild(num);
                }

                span.appendChild(a);
                threadList.appendChild(span);

                a.onclick = () => loadThreads("", category.id);
            }
        }

        async function loadThreads(query = "", categoryId = null) {
            document.getElementById("listTitle").textContent = "スレッド一覧";

            let queryBuilder = supabase
                .from("bbs_thread")
                .select(`
            id,
            title,
            created_at,
            created_by,
            bbs_category ( id, name ),
            bbs ( created_at )
        `)
                .order("created_at", { ascending: false });

            if (categoryId) {
                queryBuilder = queryBuilder.eq("category_id", categoryId);
            }

            const { data: threads, error } = await queryBuilder;

            if (error) {
                console.error(error);
                return;
            }

            threadList.innerHTML = "";

            const backButton = document.createElement("button");
            backButton.textContent = "カテゴリ選択に戻る";
            backButton.onclick = loadCategories;
            threadList.appendChild(backButton);

            let filtered = threads;

            if (query) {
                filtered = threads.filter(t =>
                    t.title.toLowerCase().includes(query)
                );
            }

            if (filtered.length === 0) {
                threadList.innerHTML = "<p>該当するスレッドが見つかりませんでした。</p>";
                return;
            }

            for (const thread of filtered) {
                const span = document.createElement("span");
                span.className = "content-list-item";

                const a = document.createElement("a");
                a.href = `thread/index.html?id=${thread.id}`;
                a.style.color = "inherit";

                const h3 = document.createElement("h3");
                h3.innerHTML = renderMarkdown(thread.title).replace(/<p[^>]*>(.*?)<\/p>/g, "$1");
                a.appendChild(h3);

                if (!categoryId) {
                    const category = document.createElement("p");
                    category.innerHTML =
                        `<i class="fa-solid fa-folder"></i> ${thread.bbs_category?.name || "未分類"}`;
                    a.appendChild(category);
                }

                const { data: user, error: userError } = await supabase
                    .from("users")
                    .select("display_name")
                    .eq("user_id", thread.created_by)
                    .single();

                const createdBy = document.createElement("p");
                createdBy.innerHTML =
                    `<i class="fa-solid fa-user"></i> ${renderMarkdown(user?.display_name).replace(/<p[^>]*>(.*?)<\/p>/g, "$1") || "とある水戸一の名無し"}`;
                a.appendChild(createdBy);

                const lastUpdate = document.createElement("p");
                lastUpdate.innerHTML =
                    `<i class="fa-solid fa-clock-rotate-left"></i> ${new Date(thread.created_at).toLocaleString()}`;
                a.appendChild(lastUpdate);

                span.appendChild(a);
                threadList.appendChild(span);
            };
        }

        document.addEventListener("DOMContentLoaded", async () => {
            await loadCategories();
        });

        document.getElementById("search-btn").addEventListener("click", async () => {
            const query = document.getElementById("search-box").value.trim().toLowerCase();
            await loadThreads(query);
        });

        document.getElementById("search-box").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("search-btn").click();
            }
        });
    </script>

    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script type="module" src="../script/restriction.js"></script>
    <script type="module" src="../script/notification.js"></script>
    <script src="../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>