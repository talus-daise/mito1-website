<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>新規投稿 - 掲示板 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <style>
        .post-item {
            margin: 1rem;
        }

        .post-item .username {
            color: #2c3e50;
        }

        .post-item p {
            white-space: pre-wrap;
            margin: 0.5rem 0;
        }

        #postList {
            margin-top: 2rem;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/" type="module"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../"><i class="fa-solid fa-chalkboard"></i>掲示板</a>
            <a href="./"><i class="fa-solid fa-pen-to-square"></i>新規スレッド作成</a>
        </p>
    </header>

    <main>
        <h1>新規スレッド作成</h1>
        <a href="../">掲示板トップへ</a>

        <section>
            <h2>スレッド一覧</h2>
            <p><label for="search-box">検索：<input type="text" id="search-box" placeholder="スレッドを検索..."></label>
                <button id="search-btn">検索</button>
            </p>
            <ul id="threadList"></ul>
        </section>

        <section>
            <h2>新規スレッド作成</h2>
            <form id="newThreadForm">
                <h3>スレッド名</h3>
                <p><input type="text" id="threadName" placeholder="スレッド名" required><br></p>
                <p>カテゴリ: <select id="category" required></select></p>
                <p><small>新規カテゴリの作成は<a
                            href="mailto:yamamoto.yuujirou@mito1-h.ibk.ed.jp?subject=ウェブサイトについての要望&body=要望の内容:%0D%0A%0D%0A不具合の報告の場合は以下の情報もご記入ください。%0D%0A- 使用端末（例: Windows PC, iPad, スマートフォンなど）%0D%0A- 使用ブラウザ（例: Chrome, Safari, Edgeなど）%0D%0A- 発生日時（例: 2025年2月28日 14:30頃）%0D%0A- スクリーンショットなどがあると尚良いです。%0D%0A- 不具合の詳細な説明:"
                            target="_blank" rel="noopener noreferrer">yamamoto.yuujirou@mito1-h.ibk.ed.jp</a>まで</small>
                </p>
                <hr>
                <h3>最初の投稿</h3>
                <div class="format-buttons">
                    <button id="bold"><strong>B</strong></button>
                    <button id="italic"><em>I</em></button>
                    <button id="strikethrough"><s>S</s></button>
                    <button id="link"><i class="fa-solid fa-link"></i></button>
                </div>
                <p><textarea id="content" placeholder="本文" required></textarea><br></p>
                <p><button type="submit">スレッド作成＆投稿</button></p>
            </form>

            <h3>プレビュー</h3>
            <div id="preview"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p><a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        document.addEventListener("DOMContentLoaded", async () => {
            // === ログインユーザー情報を取得 ===
            const { data: { session } } = await supabase.auth.getSession();
            if (session && session.user) {
                const userId = session.user.id;

                // ✅ 既存の表示名を取得（カラム名を user_id に合わせ、レコードが無い場合を考慮）
                const { data: userRecord } = await supabase
                    .from("users")
                    .select("display_name")
                    .eq("user_id", userId)
                    .single();

                // === スレッド作成フォーム ===
                document.getElementById("newThreadForm").addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const title = document.getElementById("threadName").value.trim();
                    const contentRaw = document.getElementById("content").value.trim();
                    const categoryId = document.getElementById("category").value; // selectでカテゴリ取得

                    if (!title || !contentRaw || !categoryId) {
                        showCustomNotification("必須項目を入力してください！");
                        return;
                    }

                    const { data: { session } } = await supabase.auth.getSession();
                    if (!session) {
                        showCustomNotification("ログインしてください。");
                        return;
                    }

                    const userId = session.user.id;
                    const userEmail = session.user.email;

                    const { data: user } = await supabase
                        .from("users")
                        .select("display_name")
                        .eq("user_id", userId)
                        .single();

                    const username = user?.display_name || "とある水戸一の名無し";

                    // ① スレッド作成
                    const { data: threadData, error: threadError } = await supabase
                        .from("bbs_thread")
                        .insert([{
                            title,
                            category_id: categoryId,
                            created_by: userId,
                        }])
                        .select()
                        .single();

                    if (threadError) {
                        console.error(threadError);
                        showCustomNotification("スレッド作成に失敗しました");
                        return;
                    }

                    // ② 最初の投稿を作成
                    const { error: postError } = await supabase
                        .from("bbs")
                        .insert([{
                            thread_id: threadData.id,
                            content: contentRaw,
                            username,
                            user_id: userId,
                            user_email: userEmail
                        }]);

                    if (postError) {
                        console.error(postError);
                        showCustomNotification("投稿に失敗しました");
                        return;
                    }

                    // 変更フラグを解除
                    isFormDirty = false;

                    // beforeunload を無効化
                    window.removeEventListener('beforeunload', beforeUnloadHandler);

                    showCustomAlert("スレッド作成完了！");
                    window.location.href = `../thread/index.html?thread=${encodeURIComponent(threadData.id)}`;
                });
            }
        });

        function loadThreads() {
            document.addEventListener("DOMContentLoaded", async () => {

                const { data: threads, error } = await supabase
                    .from("bbs_thread")
                    .select(`
                id,
                title,
                created_at,
                bbs_category (
                    name
                )
            `)
                    .order("created_at", { ascending: false });

                if (error) {
                    console.error(error);
                    return;
                }

                const threadList = document.getElementById("threadList");
                threadList.innerHTML = "";

                threads.forEach(thread => {
                    const li = document.createElement("li");
                    li.innerHTML = `
                <a href="../thread/index.html?id=${thread.id}">
                    ${parseMarkdown(thread.title)}
                </a>
                <small>(${thread.bbs_category?.name || "未分類"})</small>
                <hr>
            `;
                    threadList.appendChild(li);
                });
            });
        }

        function parseMarkdown(text) {
            // 太字: **太字**
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 斜体: *斜体*
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 取り消し線: ~~取り消し~~
            text = text.replace(/~~(.*?)~~/g, '<del>$1</del>');

            // プレースホルダー格納用
            const placeholders = {};
            let index = 0;

            // リンク: [リンク文字](URL)
            text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, (match, label, url) => {
                const key = `__URL_PLACEHOLDER_${index++}__`;
                placeholders[key] = `<a href="${url}" target="_blank" rel="noopener noreferrer">${label}</a>`;
                return key;
            });

            // 裸のURLを自動リンク化（リンクのURL部分は除外済み）
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

            text = text.replace(/\n/g, '<br>'); // 改行

            // インラインコード: `code`
            text = text.replace(/\`(.*?)\`/g, (match, code) => {
                return `<code>${code.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</code>`;
            });

            // プレースホルダーを元に戻す
            Object.keys(placeholders).forEach(key => {
                text = text.replace(key, placeholders[key]);
            });

            return text;
        }

        loadThreads();

        const textarea = document.getElementById("content");

        document.getElementById("bold").addEventListener("click", (e) => {
            e.preventDefault();
            insertAtCursor(textarea, "**", "**", " ");
        });

        document.getElementById("italic").addEventListener("click", (e) => {
            e.preventDefault();
            insertAtCursor(textarea, "*", "*", " ");
        });

        document.getElementById("strikethrough").addEventListener("click", (e) => {
            e.preventDefault();
            insertAtCursor(textarea, "~~", "~~", " ");
        });

        document.getElementById("link").addEventListener("click", (e) => {
            e.preventDefault();
            // デフォルトで「リンクテキスト」を選択
            insertAtCursor(textarea, "[", "](URL)", "リンクテキスト");
        });

        function insertAtCursor(textarea, before, after, selectText = "") {
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;

            const text = textarea.value;
            const selected = text.slice(start, end) || selectText;

            // テキスト挿入
            const newText = text.slice(0, start) + before + selected + after + text.slice(end);
            textarea.value = newText;

            // 選択範囲設定
            textarea.focus();
            textarea.setSelectionRange(start + before.length, start + before.length + selected.length);
        }

        const previewArea = document.getElementById("preview");

        document.getElementById("newThreadForm").addEventListener("keydown", async (e) => {
            // === ログイン済みユーザー情報の取得 ===
            const { data: { session } } = await supabase.auth.getSession();

            if (session && session.user) {
                const userId = session.user.id;
                const userEmail = session.user.email;

                const { data: user } = await supabase
                    .from("users")
                    .select("display_name")
                    .eq("user_id", userId)
                    .single();

                const username = parseMarkdown((user?.display_name || "とある水戸一の名無し").trim());
                const content = parseMarkdown(document.getElementById("content").value.trim());

                previewArea.innerHTML = `
                <div class="post-item">
                    <span>1. </span>
                    <strong class="username" data-user-id="${userId}">${username || "とある水戸一の名無し"}</strong> 
                    <small>${new Date().toLocaleString()}</small>
                    <br>
                    <p>${content}</p>
                </div>
            `
            }
        })

        let isFormDirty = false;

        const formElements = [
            document.getElementById('threadName'),
            document.getElementById('content'),
        ];

        formElements.forEach(el => {
            el.addEventListener('input', () => {
                isFormDirty = true;
            });
        });

        function beforeUnloadHandler(event) {
            if (isFormDirty) {
                event.preventDefault();
                event.returnValue = '';
            }
        }

        window.addEventListener('beforeunload', beforeUnloadHandler);

        document.getElementById("search-btn").addEventListener("click", async () => {
            const query = document.getElementById("search-box").value.trim();

            const { data: threads, error } = await supabase
                .from("bbs_thread")
                .select("id, title")
                .ilike("title", `%${query}%`)
                .order("created_at", { ascending: false });

            if (error) {
                console.error(error);
                return;
            }

            const threadList = document.getElementById("threadList");

            if (threads.length === 0) {
                threadList.innerHTML = "<p>該当するスレッドが見つかりませんでした。</p>";
                return;
            }

            threadList.innerHTML = threads.map(t => `
        <li>
            <a href="thread/index.html?id=${t.id}">
                ${parseMarkdown(t.title)}
            </a>
        </li>
    `).join("");
        });

        document.getElementById("search-box").addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                document.getElementById("search-btn").click();
            }
        });

        async function loadCategories() {
            const { data, error } = await supabase
                .from("bbs_category")
                .select("id, name")
                .order("name", { ascending: true });

            if (error) {
                console.error(error);
                return;
            }

            const select = document.getElementById("category");
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = "カテゴリを選択";
            select.appendChild(defaultOption);
            data.forEach(category => {
                const option = document.createElement("option");
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }

        document.addEventListener("DOMContentLoaded", loadCategories);
    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>