<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>掲示板 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <style>
        .post-item {
            margin: 1rem;
        }

        .post-item .username {
            color: #2c3e50;
        }

        .post-item p {
            white-space: pre-wrap;
            margin: 0.5rem 0;
        }

        #postList {
            margin-top: 2rem;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../"><i class="fa-solid fa-chalkboard"></i>掲示板</a>
            <span id="threadTitle"><a href="./"><i class="fa-solid fa-pen-to-square"></i></a></span>
        </p>
    </header>

    <main>
        <h1 id="pageTitle">掲示板</h1>
        <a href="../">掲示板トップへ</a>

        <section>
            <h2 id="listTitle">投稿一覧</h2>
            <p><a href="#" id="goToLastPost">一番下へ</a></p>
            <div id="postList"></div>
        </section>

        <section>
            <h2>新規投稿</h2>
            <form id="postForm">
                <div class="format-buttons">
                    <button id="bold"><strong>B</strong></button>
                    <button id="italic"><em>I</em></button>
                    <button id="strikethrough"><s>S</s></button>
                    <button id="link"><i class="fa-solid fa-link"></i></button>
                </div>
                <p><textarea id="content" placeholder="本文" required></textarea></p>
                <p><button type="submit">投稿</button></p>
            </form>

            <h3>プレビュー</h3>
            <div id="preview"></div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p><a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        // --- Markdown初期化 ---
        const md = window.markdownit({
            html: false,      // HTMLタグ禁止（重要）
            linkify: true,    // URL自動リンク
        });

        function renderMarkdown(text) {
            const escaped = (text || "").replace(/>>(\d+)/g, "&gt;&gt;$1");
            const raw = md.render(escaped);
            return DOMPurify.sanitize(raw);
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const params = new URLSearchParams(window.location.search);
            const threadId = params.get("id");   // ← 変更
            const postId = params.get("post_id");

            if (!threadId) {
                listTitle.textContent = "スレッドが指定されていません";
                return;
            }

            const listTitle = document.getElementById("listTitle");
            const postList = document.getElementById("postList");
            const postForm = document.getElementById("postForm");
            const usernameInput = document.getElementById("username");

            const { data: threadData, error: threadError } = await supabase
                .from("bbs_thread")
                .select("title")
                .eq("id", threadId)
                .single();

            if (threadError || !threadData) {
                listTitle.textContent = "スレッドが見つかりません";
                return;
            }

            const threadTitle = threadData.title;

            listTitle.innerHTML = renderMarkdown(threadTitle).replace(/<p[^>]*>(.*?)<\/p>/g, "$1");
            document.querySelector("#threadTitle>a").innerHTML =
                '<i class="fa-solid fa-pen-to-square"></i>' + renderMarkdown(threadTitle).replace(/<p[^>]*>(.*?)<\/p>/g, "$1");

            // === ログイン済みユーザー情報の取得 ===
            const { data: { session } } = await supabase.auth.getSession();

            if (session && session.user) {
                const userId = session.user.id;
                const userEmail = session.user.email;

                // ✅ 表示名を取得
                const { data: user } = await supabase
                    .from("users")
                    .select("display_name")
                    .eq("user_id", userId)
                    .single();

                // === 投稿フォーム送信 ===
                postForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const username = user?.display_name?.trim() || "とある水戸一の名無し";
                    const content = document.getElementById("content").value.trim();

                    if (!content) {
                        showCustomNotification("内容を入力してください。");
                        return;
                    }

                    const { error } = await supabase.from("bbs").insert([{
                        thread_id: threadId,   // ← 変更
                        username,
                        content,
                        user_id: userId,
                        user_email: userEmail
                    }]);

                    if (error) {
                        console.error(error);
                        showCustomNotification("投稿に失敗しました。");
                        return;
                    }

                    postForm.reset();
                });
            } else {
                // 未ログイン時
                usernameInput.placeholder = "ログインしていません";
                postForm.addEventListener("submit", (e) => {
                    e.preventDefault();
                    showCustomAlert("ログインしてから投稿してください。", false);
                });
            }

            function formatContent(content) {
                return content.replace(/&gt;&gt;(\d+)/g, '<a href="#" class="goToPost" data-post-index="$1">>>$1</a>');
            }

            // === 投稿一覧表示 ===
            async function loadPosts() {
                const { data: posts, error } = await supabase
                    .from("bbs")
                    .select("*")
                    .eq("thread_id", threadId)   // ← 変更
                    .order("created_at", { ascending: true });

                if (error) {
                    console.error(error);
                    return;
                }

                document.getElementById("goToLastPost").addEventListener("click", () => {
                    smoothScroll(document.getElementById(`index-${posts.length}`))
                })

                postList.innerHTML = posts
                    .map((post, index) => `
        <div class="post-item" id="index-${index + 1}">
            <span>${index + 1}. </span>
            <strong class="username" data-user-id="${post.user_id}">${post.username?.trim() || "とある水戸一の名無し"}</strong>
            <small>${new Date(post.created_at).toLocaleString()}</small>
            <br>
            <p>${formatContent(renderMarkdown(post.content))}</p>
        </div>
        <hr>
        `).join("");

                document.querySelectorAll(".username").forEach((element) => {
                    element.style.cursor = "alias";
                    element.title = "ユーザーページを表示";

                    element.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        const userId = element.getAttribute("data-user-id");
                        const url =
                            `/mito1-website/mypage/other/?user_id=${encodeURIComponent(userId)}&redirect_url=/mito1-website/bbs/`;

                        const w = window.open(url, "_blank");
                        if (w) {
                            w.opener = null;
                        }
                    });
                });

                // postId が指定されていれば該当投稿までスクロール
                if (postId && !window.postIdScrolled) {
                    const idx = posts.findIndex(p => String(p.id) === String(postId));
                    if (idx !== -1) {
                        const postDivs = postList.querySelectorAll('div');
                        const target = postDivs[idx];
                        if (target) {
                            smoothScroll(target)
                            // postIdを一度だけ使う
                            window.postIdScrolled = true;
                        }
                    }
                }

                document.querySelectorAll(".goToPost").forEach((elem) => {
                    elem.addEventListener("click", (e) => {
                        e.preventDefault()
                        smoothScroll(document.getElementById(`index-${elem.dataset.postIndex}`))
                    })
                })
            }

            await loadPosts();

            // === 書式ボタン ===
            const textarea = document.getElementById("content");
            const buttons = {
                bold: ["**", "**", "太字"],
                italic: ["*", "*", "斜体"],
                strikethrough: ["~~", "~~", "取り消し線"],
                link: ["[", "](URL)", "リンクテキスト"]
            };

            Object.entries(buttons).forEach(([id, [before, after, placeholder]]) => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.addEventListener("click", (e) => {
                        e.preventDefault();
                        insertAtCursor(textarea, before, after, placeholder);
                    });
                }
            });

            function insertAtCursor(textarea, before, after, selectText = "") {
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const selected = text.slice(start, end) || selectText;
                const newText = text.slice(0, start) + before + selected + after + text.slice(end);
                textarea.value = newText;
                textarea.focus();
                textarea.setSelectionRange(start + before.length, start + before.length + selected.length);
            }

            // === プレビュー更新 ===
            const previewArea = document.getElementById("preview");
            previewArea.style.marginTop = "1rem";
            postForm.addEventListener("keydown", async () => {
                const { data: { session } } = await supabase.auth.getSession();

                if (session && session.user) {
                    const userId = session.user.id;
                    const userEmail = session.user.email;

                    const { data: user } = await supabase
                        .from("users")
                        .select("display_name")
                        .eq("user_id", userId)
                        .single();

                    const username = renderMarkdown(user.display_name);
                    const content = renderMarkdown(document.getElementById("content").value.trim());
                    previewArea.innerHTML = `
        <div class="post-item">
            <span>x. </span>
            <strong>${username || "とある水戸一の名無し"}</strong>
            <small>${new Date().toLocaleString()}</small>
            <br>
            <p>${content}</p>
        </div>
        <hr>
        `;
                }
            });

            const channel = supabase
                .channel('BBS')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'bbs',
                        filter: `thread_id=eq.${threadId}`  // ← 変更
                    },
                    (payload) => {
                        appendPost(payload.new);
                    }
                )
                .subscribe();

            function appendPost(post) {
                // すでに同じIDの投稿があれば何もしない
                if (document.querySelector(`[data-post-id="${post.id}"]`)) return;

                const index = postList.querySelectorAll('.post-item').length + 1;

                const div = document.createElement('div');
                div.className = 'post-item';
                div.id = `index-${index}`;
                div.dataset.postId = post.id;

                div.innerHTML = `
        <span>${index}. </span>
        <strong class="username" data-user-id="${post.user_id}">
            ${renderMarkdown(post.username || "とある水戸一の名無し")}
        </strong>
        <small>${new Date(post.created_at).toLocaleString()}</small>
        <br>
        <p>${formatContent(renderMarkdown(post.content))}</p>
        `;

                postList.appendChild(div);
                postList.appendChild(document.createElement('hr'));
            }
        });

        function smoothScroll(target) {
            if (!target) return;
            target.scrollIntoView({ behavior: "smooth", block: "center" });
            // 簡単なハイライト
            const originalBg = target.style.backgroundColor;
            target.style.backgroundColor = '#fffbcc';
            setTimeout(() => {
                target.style.transition = 'background-color 1s'; target.style.backgroundColor = originalBg ||
                    '';
            }, 1000);
        }

        // === ページ離脱警告 ===
        window.addEventListener('beforeunload', (event) => {
            const content = document.getElementById('content').value.trim();
            const username = document.getElementById('username').value.trim();
            if (!content && !username) return;
            event.preventDefault();
            event.returnValue = '';
        });
    </script>

    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>