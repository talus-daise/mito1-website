<!DOCTYPE html>
<html lang="ja">

<head>
    <!--æ–‡å­—ã‚³ãƒ¼ãƒ‰ãƒ»äº’æ›ãƒ¢ãƒ¼ãƒ‰-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ›² | æ°´æˆ¸ä¸€é«˜é™„å±ä¸­ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</title>
    <!--ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <style>
        .show {
            display: block;
        }

        .hide {
            display: none;
        }
    </style>
    <!--webæƒ…å ±-->
    <meta name="keywords" content="æ°´æˆ¸ä¸€, æ°´æˆ¸ä¸€é™„å±, æ°´æˆ¸ä¸€é™„å±ä¸­, ä¸€å­¦å¹´,">
    <meta name="description" content="æ°´æˆ¸ä¸€é™„å±ä¸­å››æœŸç”Ÿå‘ã‘ã®ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§ã™ã€‚é™„å±ä¸­å‘ã‘ã®ãƒ†ã‚¹ãƒˆã®æƒ…å ±ãªã©ã‚’é…ä¿¡ã—ã¦ã„ã¾ã™ã€‚">
    <meta name="author" content="Â©ï¸ 2025 talus">
    <!--æ›´æ–°æ—¥æ™‚-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/two-grade-website/">
    <!--ã‚¢ã‚¤ã‚³ãƒ³-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>

    <!--ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ-->
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">æ°´æˆ¸ä¸€é«˜é™„å±ä¸­ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>
            <a href="./"><i class="fa-solid fa-music"></i>ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ›²ä¸€è¦§</a>
        </p>
    </header>

    <main>
        <h1>ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ›²ä¸€è¦§</h1>
        <section>
            <h2>æ›²å¿œå‹Ÿ</h2>
            <form id="sendRequest">
                <p><label for="music-name">æ›²å: </label><input type="text" name="music-name" id="musicName"></p>
                <p><label for="url">æ›²ã®URL: </label><input type="url" name="url" id="musicUrl"></p>
                <p><label for="description">ãŠã™ã™ã‚ãƒã‚¤ãƒ³ãƒˆãªã©(ç©ºæ¬„ã§ã‚‚OK): </label><input type="text" name="description"
                        id="description"></p>
                <p><input type="submit" value="é€ä¿¡"></p>
            </form>
        </section>
        <section>
            <h2>ä»Šæ—¥æµã™äºˆå®šã®æ›²</h2>
            <div id="container">
                <p><button id="randomMusic">ãƒ©ãƒ³ãƒ€ãƒ é¸æ›²</button></p>
                <div id="selectedMusic"></div>

                <p id="openMusic">â–¼ æ›²åä¸€è¦§(ã‚¯ãƒªãƒƒã‚¯ã§é–‹ãã¾ã™)</p>
                <div id="todayMusic"></div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>â€»ã“ã®ã‚µã‚¤ãƒˆã¯å­¦æ ¡éå…¬èªã®å€‹äººãŒé‹å–¶ã—ã¦ã„ã‚‹ã‚µã‚¤ãƒˆã§ã™ã€‚å­¦æ ¡å´ã®å•é¡Œã«è²¬ä»»ã¯å–ã‚Œã¾ã›ã‚“ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚</p>
        <p><a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">èŒ¨åŸçœŒç«‹æ°´æˆ¸ç¬¬ä¸€é«˜ç­‰å­¦æ ¡é™„å±ä¸­å­¦æ ¡HP</a>
        </p>
    </footer>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        // ===== Supabase åˆæœŸåŒ– =====
        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError) {
            console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", userError);
            showCustomAlert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„", false)
        } else {
            console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:", user);
        }

        const userEmail = user.email;
        const currentUser = user;

        const { data } = await supabase
            .from("users")
            .select("*")
            .eq("user_email", userEmail)
            .single();

        if (!data) {
            await supabase.from("users").insert([{
                user_id: currentUser.id,
                user_email: userEmail,
                visit_count: 1,
                avatar_url: currentUser.user_metadata.avatar_url,
                full_name: currentUser.user_metadata.full_name
            }]);
        } else {
            await supabase.from("users")
                .update({
                    avatar_url: currentUser.user_metadata.avatar_url,
                    full_name: currentUser.user_metadata.full_name
                })
                .eq("user_email", userEmail);
        }

        // ===== è¦ç´ å‚ç…§ =====
        const sendForm = document.getElementById("sendRequest");
        const openMusicBtn = document.getElementById("openMusic");
        const randomMusicBtn = document.getElementById("randomMusic");
        const todayMusic = document.getElementById("todayMusic");
        const todayMusicList = document.createElement("div");
        let musicData = [];

        // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
        function showNotification(message) {
            showCustomNotification(message);
        }

        function convertEmbedLink(link) {
            let videoId = "";
            if (link.includes("watch?v=")) {
                videoId = new URL(link).searchParams.get("v");
            } else if (link.includes("youtu.be/")) {
                videoId = link.split("youtu.be/")[1].split("?")[0];
            }
            return videoId ? `https://www.youtube.com/embed/${videoId}` : "";
        }

        function createMusicItem(musicName, url, desc, studentId, isOpened = false, isToggleable = false, isPlayedToggleable = true) {
            const div = document.createElement("div");

            const title = document.createElement("h3");
            title.textContent = musicName;
        
            const requester = document.createElement("p");
            requester.innerHTML = `<i class="fa-solid fa-user"></i> ${studentId}`;
            
            const description = document.createElement("p");
            description.textContent = desc;
            
            const videoContainer = document.createElement("div");
            const toggleText = document.createElement("p");
            if (isToggleable) toggleText.textContent = "â–¼ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã";
            videoContainer.appendChild(toggleText);
            
            const iframe = document.createElement("iframe");
            Object.assign(iframe, {
                src: convertEmbedLink(url),
                frameBorder: "0",
                allowFullscreen: true,
                allow: "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
            });

            if (isPlayedToggleable) {
                videoContainer.addEventListener("click", () => {
                    const opened = videoContainer.classList.toggle("show");
                    videoContainer.innerHTML = "";
                    const newText = document.createElement("p");
                    newText.textContent = opened ? "â–¼ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹" : "â–¼ã‚¯ãƒªãƒƒã‚¯ã§é–‹ã";
                    videoContainer.appendChild(newText);
                    if (opened) videoContainer.appendChild(iframe);
                });
            } else {
                videoContainer.appendChild(iframe);
            }
            
            
            const p = document.createElement("p");
            const label = document.createElement("label");
            label.textContent = "å†ç”Ÿæ¸ˆã¿: ";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = false;
            checkbox.disabled = !isToggleable;
            label.appendChild(checkbox);
            p.appendChild(label);

            checkbox.addEventListener("change", async () => {
                const { error } = await supabase
                    .from("request_music")
                    .update({ isplayed: checkbox.checked })
                    .eq("musicName", musicName)
                    .eq("url", url);

                if (error) showNotification("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error.message);
                else showNotification("æ›´æ–°ã—ã¾ã—ãŸï¼");
            });

            div.append(title, requester, videoContainer, description, p, document.createElement("hr"));

            if (isOpened) videoContainer.click();

            return div;
        }

        // ===== ãƒ‡ãƒ¼ã‚¿å–å¾— =====
        async function getTodayMusic() {
            const { data, error } = await supabase
                .from("request_music")
                .select("*")
                .order("musicName", { ascending: true })
                .eq("isplayed", false);

            if (error) {
                showNotification("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                console.error(error);
                return;
            }

            musicData = data;
            todayMusicList.innerHTML = "";
            data.forEach(({ musicName, url, desc, studentId }) => {
                todayMusicList.appendChild(createMusicItem(musicName, url, desc, studentId));
            });
        }

        function getStudentId(namesJson, fullName) {
            for (const [cls, list] of Object.entries(namesJson)) {
                if (!Array.isArray(list)) continue;
                const index = list.indexOf(fullName);
                if (index !== -1) {
                    return `${cls}${String(index + 1).padStart(2, "0")}`;
                }
            }
            return "0A00";
        }

        // ===== é€ä¿¡å‡¦ç† =====
        sendForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const now = new Date();
            const lastDateStr = localStorage.getItem("lastRequestMusicDate");
            if (lastDateStr) {
                const lastDate = new Date(lastDateStr);
                const lastMonday = new Date(now);
                lastMonday.setDate(now.getDate() - now.getDay() + 1);
                if (lastDate < lastMonday) localStorage.setItem("weekofRequestMusicNumber", "0");
            }

            if ((localStorage.getItem("weekofRequestMusicNumber") || "0") >= "5") {
                showNotification("ä»Šé€±ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚");
                return;
            }

            // --- å­¦ç±ç•ªå·å–å¾— ---
            let studentId = "0A00";
            try {
                // ğŸ” studentsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—
                const { data: student, error } = await supabase
                    .from("students")
                    .select("student_id")
                    .eq("name", user.user_metadata.full_name)
                    .single();
                if (error) {
                    console.error(error);
                    return;
                }
                studentId = student.student_id;
            } catch (e) {
                console.error("åå‰ã‚ˆã‚Šå­¦ç±ç•ªå· èª­ã¿è¾¼ã¿å¤±æ•—", e);
            }
            const musicName = document.getElementById("musicName").value.trim();
            const url = document.getElementById("musicUrl").value.trim();
            const desc = document.getElementById("description").value.trim();
            const userId = data.user_id;

            if (!studentId.startsWith("2A")) {
                showNotification("2Açµ„ã®ç”Ÿå¾’ã®ã¿ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã¾ã™ã€‚");
                return;
            }

            if (!studentId || !musicName || !url || (!url.includes("watch?v=") && !url.includes("youtu.be/"))) {
                showNotification("æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            const { data: existingData, error: existingError } = await supabase
                .from("request_music")
                .select("*")
                .or(`musicName.eq.${musicName},url.eq.${url}`);

            if (existingError) return showNotification("ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ï¼š" + existingError.message);
            if (existingData && existingData.length > 0) return showNotification("ã“ã®æ›²ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚");

            const { error } = await supabase.from("request_music").insert([{ studentId, musicName, url, desc, user_id: userId }]);
            if (error) return showNotification("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + error.message);

            showNotification("é€ä¿¡ã—ã¾ã—ãŸï¼");
            sendForm.reset();
            getTodayMusic();
            localStorage.setItem("weekofRequestMusicNumber", String(Number(localStorage.getItem("weekofRequestMusicNumber") || "0") + 1));
            localStorage.setItem("lastRequestMusicDate", new Date().toISOString());
        });

        // ===== ãƒœã‚¿ãƒ³æ“ä½œ =====
        openMusicBtn.addEventListener("click", () => {
            const isOpen = todayMusic.classList.toggle("open");
            if (isOpen) todayMusic.appendChild(todayMusicList);
            else if (todayMusic.contains(todayMusicList)) todayMusic.removeChild(todayMusicList);
        });

        function buildSubmitCountMap(data) {
            const map = {};
            data
                .filter(item => !item.isplayed)
                .forEach(item => {
                    map[item.studentId] = (map[item.studentId] || 0) + 1;
                });
            return map;
        }

        let lastSelectedStudentId = null;

        function weightedRandomChoice(items, submitCountMap) {
            // æœªå†ç”Ÿã®ã¿å¯¾è±¡
            const unplayed = items.filter(item => !item.isplayed);

            if (!unplayed.length) return null;

            // é€£ç¶šåŒä¸€å­¦ç±ç•ªå·å›é¿
            const filtered = unplayed.filter(
                item => item.studentId !== lastSelectedStudentId
            );
            const targetItems = filtered.length ? filtered : unplayed;

            const weights = targetItems.map(item => {
                const count = submitCountMap[item.studentId] || 1;
                return 1 / count;
            });

            const total = weights.reduce((a, b) => a + b, 0);
            let r = Math.random() * total;

            for (let i = 0; i < targetItems.length; i++) {
                r -= weights[i];
                if (r <= 0) {
                    lastSelectedStudentId = targetItems[i].studentId;
                    return targetItems[i];
                }
            }

            lastSelectedStudentId = targetItems[targetItems.length - 1].studentId;
            return targetItems[targetItems.length - 1];
        }

        randomMusicBtn.addEventListener("click", () => {
            const unplayed = musicData.filter(item => !item.isplayed);
            if (!unplayed.length) {
                showNotification("æœªå†ç”Ÿã®æ›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }

            const submitCountMap = buildSubmitCountMap(unplayed);

            let count = 0;
            const selectedMusic = document.getElementById("selectedMusic");

            const intervalId = setInterval(() => {
                const item = weightedRandomChoice(unplayed, submitCountMap);
                if (!item) return;

                const { musicName, url, desc, studentId } = item;

                selectedMusic.innerHTML = "";
                selectedMusic.classList.add("open");
                selectedMusic.appendChild(
                    createMusicItem(musicName, url, desc, studentId, true, true, false)
                );

                if (++count >= 20) {
                    clearInterval(intervalId);
                    enlargeIframe(selectedMusic.querySelector("iframe"));
                }
            }, 50);
        });

        // ===== YouTubeå…¨ç”»é¢ã‚¢ãƒ‹ãƒ¡ =====
        function enlargeIframe(iframe) {
            if (!iframe) return;
            const startWidth = 200, startHeight = 150;
            const targetWidth = window.innerWidth, targetHeight = window.innerHeight;

            Object.assign(iframe.style, {
                position: "fixed",
                top: "50%",
                left: "50%",
                width: startWidth + "px",
                height: startHeight + "px",
                transform: "translate(-50%, -50%)",
                zIndex: 9999,
                border: "none",
                margin: 0,
                borderRadius: "0",
            });

            const startTime = performance.now();
            const duration = 500;

            function expandAnimation(now) {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;

                iframe.style.width = `${startWidth + (targetWidth - startWidth) * ease}px`;
                iframe.style.height = `${startHeight + (targetHeight - startHeight) * ease}px`;

                if (progress < 1) requestAnimationFrame(expandAnimation);
                else Object.assign(iframe.style, { top: 0, left: 0, width: "100vw", height: "100vh", transform: "none" });
            }

            requestAnimationFrame(expandAnimation);

            const closeBtn = document.createElement("button");
            Object.assign(closeBtn.style, {
                position: "fixed",
                top: "10px",
                right: "10px",
                zIndex: 10000,
                fontSize: "24px",
                background: "rgba(0,0,0,0.5)",
                color: "#fff",
                border: "none",
                borderRadius: "5px",
                padding: "5px 10px",
                cursor: "pointer",
            });
            closeBtn.textContent = "âœ–";
            document.body.appendChild(closeBtn);

            closeBtn.addEventListener("click", () => {
                iframe.style.width = "auto";
                iframe.style.height = "auto";
                iframe.style.position = "static";
                closeBtn.remove();
            });
        }

        function shrinkIframe(iframe, closeBtn, startW, startH, targetW, targetH) {
            const shrinkStart = performance.now();
            const shrinkDuration = 300;

            function shrinkAnimation(now) {
                const elapsed = now - shrinkStart;
                const progress = Math.min(elapsed / shrinkDuration, 1);
                const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;

                iframe.style.width = `${targetW - (targetW - startW) * ease}px`;
                iframe.style.height = `${targetH - (targetH - startH) * ease}px`;

                if (progress < 1) requestAnimationFrame(shrinkAnimation);
                else {
                    iframe.remove();
                    closeBtn.remove();
                }
            }

            requestAnimationFrame(shrinkAnimation);
        }

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                const iframe = document.querySelector("#selectedMusic iframe");
                if (iframe) {
                    iframe.style.width = "auto";
                    iframe.style.height = "auto";
                    iframe.style.position = "static";
                    const closeBtn = document.querySelector("button[style*='position: fixed']");
                    if (closeBtn) closeBtn.remove();
                }
            }
        });

        // ===== åˆå›èª­ã¿è¾¼ã¿ =====
        getTodayMusic();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script type="module" src="../script/restriction.js"></script>
    <script type="module" src="../script/notification.js"></script>
    <script src="../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>