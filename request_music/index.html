<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>リクエスト曲 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <style>
        .show {
            display: block;
        }

        .hide {
            display: none;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中四期生向けの総合ウェブサイトです。附属中向けのテストの情報などを配信しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/two-grade-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>

    <!--マニフェスト-->
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="./"><i class="fa-solid fa-music"></i>リクエスト曲一覧</a>
        </p>
    </header>

    <main>
        <h1>リクエスト曲一覧</h1>
        <section>
            <h2>曲応募</h2>
            <form id="sendRequest">
                <label for="student-ID">学籍番号: </label><input type="text" name="student-ID" id="studentId"><br>
                <label for="music-name">曲名: </label><input type="text" name="music-name" id="musicName"><br>
                <label for="url">曲のURL: </label><input type="url" name="url" id="musicUrl"><br>
                <label for="description">おすすめポイントなど(空欄でもOK): </label><input type="text" name="description"
                    id="description"><br>
                <input type="submit" value="送信">
            </form>
        </section>
        <section>
            <h2>今日流す予定の曲</h2>
            <div id="container">
                <button id="randomMusic">ランダム選曲</button>
                <div id="selectedMusic"></div>

                <p id="openMusic">▼ ネタバレ防止(クリックで開きます)</p>
                <div id="todayMusic"></div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p><a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>


    <script src="../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        // ===== Supabase 初期化 =====
        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        const { data: user, error: userError } = await supabase.auth.getUser();
        if (userError) {
            console.error("ユーザー情報の取得に失敗しました:", userError);
            showCustomAlert("ログインしてください", false)
        } else {
            console.log("ユーザー情報:", user);
        }

        // ===== 要素参照 =====
        const sendForm = document.getElementById("sendRequest");
        const openMusicBtn = document.getElementById("openMusic");
        const randomMusicBtn = document.getElementById("randomMusic");
        const todayMusic = document.getElementById("todayMusic");
        const todayMusicList = document.createElement("div");
        let musicData = [];

        // ===== ユーティリティ =====
        function showNotification(message) {
            showCustomNotification(message);
        }

        function convertEmbedLink(link) {
            let videoId = "";
            if (link.includes("watch?v=")) {
                videoId = new URL(link).searchParams.get("v");
            } else if (link.includes("youtu.be/")) {
                videoId = link.split("youtu.be/")[1].split("?")[0];
            }
            return videoId ? `https://www.youtube.com/embed/${videoId}` : "";
        }

        function createMusicItem(musicName, url, desc, studentId, isOpened = false, isToggleable = false) {
            const div = document.createElement("div");

            const title = document.createElement("h3");
            title.textContent = musicName;

            const description = document.createElement("p");
            description.textContent = desc;

            const videoContainer = document.createElement("div");
            const toggleText = document.createElement("p");
            if (isToggleable) toggleText.textContent = "▼クリックで開く";
            videoContainer.appendChild(toggleText);

            const iframe = document.createElement("iframe");
            Object.assign(iframe, {
                src: convertEmbedLink(url),
                frameBorder: "0",
                allowFullscreen: true,
                allow: "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen"
            });

            if (isToggleable) {
                videoContainer.addEventListener("click", () => {
                    const opened = videoContainer.classList.toggle("show");
                    videoContainer.innerHTML = "";
                    const newText = document.createElement("p");
                    newText.textContent = opened ? "▼クリックで閉じる" : "▼クリックで開く";
                    videoContainer.appendChild(newText);
                    if (opened) videoContainer.appendChild(iframe);
                });
            } else {
                videoContainer.appendChild(iframe);
            }


            const label = document.createElement("label");
            label.textContent = "再生済み: ";
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = false;
            checkbox.disabled = !isToggleable;
            label.appendChild(checkbox);

            const student = document.createElement("p");
            student.textContent = studentId;

            checkbox.addEventListener("change", async () => {
                const { error } = await supabase
                    .from("request-music")
                    .update({ isplayed: checkbox.checked })
                    .eq("musicName", musicName)
                    .eq("url", url);

                if (error) showNotification("更新に失敗しました：" + error.message);
                else showNotification("更新しました！");
            });

            div.append(title, videoContainer, description, label, document.createElement("hr"));

            if (isOpened) videoContainer.click();

            return div;
        }

        // ===== データ取得 =====
        async function getTodayMusic() {
            const { data, error } = await supabase
                .from("request-music")
                .select("*")
                .order("musicName", { ascending: true })
                .eq("isplayed", false);

            if (error) {
                showNotification("データの取得に失敗しました。");
                console.error(error);
                return;
            }

            musicData = data;
            todayMusicList.innerHTML = "";
            data.forEach(({ musicName, url, desc, studentId }) => {
                todayMusicList.appendChild(createMusicItem(musicName, url, desc, studentId));
            });
        }

        // ===== 送信処理 =====
        sendForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const now = new Date();
            const lastDateStr = localStorage.getItem("lastRequestMusicDate");
            if (lastDateStr) {
                const lastDate = new Date(lastDateStr);
                const lastMonday = new Date(now);
                lastMonday.setDate(now.getDate() - now.getDay() + 1);
                if (lastDate < lastMonday) localStorage.setItem("weekofRequestMusicNumber", "0");
            }

            if ((localStorage.getItem("weekofRequestMusicNumber") || "0") >= "5") {
                showNotification("今週の上限に達しました。");
                return;
            }

            const studentId = document.getElementById("studentId").value.trim();
            const musicName = document.getElementById("musicName").value.trim();
            const url = document.getElementById("musicUrl").value.trim();
            const desc = document.getElementById("description").value.trim();

            if (!studentId || !musicName || !url || (!url.includes("watch?v=") && !url.includes("youtu.be/"))) {
                showNotification("正しく入力してください");
                return;
            }

            const { data: existingData, error: existingError } = await supabase
                .from("request-music")
                .select("*")
                .or(`musicName.eq.${musicName},url.eq.${url}`);

            if (existingError) return showNotification("確認中にエラー：" + existingError.message);
            if (existingData && existingData.length > 0) return showNotification("この曲はすでに登録されています。");

            const { error } = await supabase.from("request-music").insert([{ studentId, musicName, url, desc }]);
            if (error) return showNotification("送信に失敗しました：" + error.message);

            showNotification("送信しました！");
            sendForm.reset();
            getTodayMusic();
            localStorage.setItem("weekofRequestMusicNumber", String(Number(localStorage.getItem("weekofRequestMusicNumber") || "0") + 1));
            localStorage.setItem("lastRequestMusicDate", new Date().toISOString());
        });

        // ===== ボタン操作 =====
        openMusicBtn.addEventListener("click", () => {
            const isOpen = todayMusic.classList.toggle("open");
            if (isOpen) todayMusic.appendChild(todayMusicList);
            else if (todayMusic.contains(todayMusicList)) todayMusic.removeChild(todayMusicList);
        });

        function buildSubmitCountMap(data) {
            const map = {};
            data
                .filter(item => !item.isplayed)
                .forEach(item => {
                    map[item.studentId] = (map[item.studentId] || 0) + 1;
                });
            return map;
        }

        let lastSelectedStudentId = null;

        function weightedRandomChoice(items, submitCountMap) {
            // 未再生のみ対象
            const unplayed = items.filter(item => !item.isplayed);

            if (!unplayed.length) return null;

            // 連続同一学籍番号回避
            const filtered = unplayed.filter(
                item => item.studentId !== lastSelectedStudentId
            );
            const targetItems = filtered.length ? filtered : unplayed;

            const weights = targetItems.map(item => {
                const count = submitCountMap[item.studentId] || 1;
                return 1 / count;
            });

            const total = weights.reduce((a, b) => a + b, 0);
            let r = Math.random() * total;

            for (let i = 0; i < targetItems.length; i++) {
                r -= weights[i];
                if (r <= 0) {
                    lastSelectedStudentId = targetItems[i].studentId;
                    return targetItems[i];
                }
            }

            lastSelectedStudentId = targetItems[targetItems.length - 1].studentId;
            return targetItems[targetItems.length - 1];
        }

        randomMusicBtn.addEventListener("click", () => {
            const unplayed = musicData.filter(item => !item.isplayed);
            if (!unplayed.length) {
                showNotification("未再生の曲がありません。");
                return;
            }

            const submitCountMap = buildSubmitCountMap(unplayed);

            let count = 0;
            const selectedMusic = document.getElementById("selectedMusic");

            const intervalId = setInterval(() => {
                const item = weightedRandomChoice(unplayed, submitCountMap);
                if (!item) return;

                const { musicName, url, desc, studentId } = item;

                selectedMusic.innerHTML = "";
                selectedMusic.classList.add("open");
                selectedMusic.appendChild(
                    createMusicItem(musicName, url, desc, studentId, true)
                );

                if (++count >= 20) {
                    clearInterval(intervalId);
                    enlargeIframe(selectedMusic.querySelector("iframe"));
                }
            }, 50);
        });

        // ===== YouTube全画面アニメ =====
        function enlargeIframe(iframe) {
            if (!iframe) return;
            const startWidth = 200, startHeight = 150;
            const targetWidth = window.innerWidth, targetHeight = window.innerHeight;

            Object.assign(iframe.style, {
                position: "fixed",
                top: "50%",
                left: "50%",
                width: startWidth + "px",
                height: startHeight + "px",
                transform: "translate(-50%, -50%)",
                zIndex: 9999,
                border: "none"
            });

            const startTime = performance.now();
            const duration = 500;

            function expandAnimation(now) {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;

                iframe.style.width = `${startWidth + (targetWidth - startWidth) * ease}px`;
                iframe.style.height = `${startHeight + (targetHeight - startHeight) * ease}px`;

                if (progress < 1) requestAnimationFrame(expandAnimation);
                else Object.assign(iframe.style, { top: 0, left: 0, width: "100vw", height: "100vh", transform: "none" });
            }

            requestAnimationFrame(expandAnimation);

            const closeBtn = document.createElement("button");
            Object.assign(closeBtn.style, {
                position: "fixed",
                top: "10px",
                right: "10px",
                zIndex: 10000,
                fontSize: "24px",
                background: "rgba(0,0,0,0.5)",
                color: "#fff",
                border: "none",
                borderRadius: "5px",
                padding: "5px 10px",
                cursor: "pointer"
            });
            closeBtn.textContent = "✖";
            document.body.appendChild(closeBtn);

            closeBtn.addEventListener("click", () => {
                iframe.style.width = "auto";
                iframe.style.height = "auto";
                iframe.style.position = "static";
                closeBtn.remove();
            });
        }

        function shrinkIframe(iframe, closeBtn, startW, startH, targetW, targetH) {
            const shrinkStart = performance.now();
            const shrinkDuration = 300;

            function shrinkAnimation(now) {
                const elapsed = now - shrinkStart;
                const progress = Math.min(elapsed / shrinkDuration, 1);
                const ease = progress < 0.5 ? 2 * progress * progress : -1 + (4 - 2 * progress) * progress;

                iframe.style.width = `${targetW - (targetW - startW) * ease}px`;
                iframe.style.height = `${targetH - (targetH - startH) * ease}px`;

                if (progress < 1) requestAnimationFrame(shrinkAnimation);
                else {
                    iframe.remove();
                    closeBtn.remove();
                }
            }

            requestAnimationFrame(shrinkAnimation);
        }

        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape") {
                const iframe = document.querySelector("#selectedMusic iframe");
                if (iframe) {
                    iframe.style.width = "auto";
                    iframe.style.height = "auto";
                    iframe.style.position = "static";
                    const closeBtn = document.querySelector("button[style*='position: fixed']");
                    if (closeBtn) closeBtn.remove();
                }
            }
        });

        // ===== 初回読み込み =====
        getTodayMusic();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/js-confetti@latest/dist/js-confetti.browser.js"></script>
    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script type="module" src="../script/restriction.js"></script>
    <script type="module" src="../script/notification.js"></script>
    <script src="../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>