<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>時間割 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../timetable/"><i class="fa-solid fa-table"></i>時間割一覧</a>
        </p>
    </header>

    <main>
        <section class="highlight">
            <h2>注意</h2>
            <p>
                時間割が見られないときは、以下の手順を踏んだ上、再読込してください。<br>
                1. <a href='https://mito1-website.loca.lt/' target='_blank' rel='noopener noreferrer'>このリンク</a>に飛ぶ<br>
                2. パスワード欄に`106.73.192.65`を入力する<br>
                3. submitを押す<br>
                4.
                ファイル一覧が表示されたら成功→名簿と時間割が表示されるようになります。
            </p>
        </section>
        <section>
            <h2>現在の時間割画像</h2>
            <img src="" alt="時間割画像" id="timetable" width="calc(100% - 2rem)">
        </section>
        <section class="main__classlist">
            <h2>時間割スプレッドシート</h2>
            <iframe src="https://docs.google.com/spreadsheets/d/1fdSGqT1s2kit91TcQV_mjcuvOawGAU6JZ_5N684bH3U/htmlview"
                title="時間割">
            </iframe>
        </section>
        <section>
            <h2>お詫び</h2>
            <p>サーバー関係の不具合で、2025-12-09 ~ 2025-12-16の時間割が保存されていなかったことに現在(2025-12-18)気が付きました…^^;</p>
            <p>そもそも保存がされていなかったようなので、残念ながら閲覧することができません…</p>
            <p>ご不便をおかけして申し訳ありません。</p>
        </section>
        <section>
            <h2>過去の時間割一覧</h2>
            <label for="search-box">検索：<input type="text" id="search-box" placeholder="時間割をファイル名から検索..."></label>
            <button id="search-btn">検索</button>
            <div id="past-timetable"></div>
        </section>
        <section>
            <h2>サーバーの稼働状況</h2>
            <p id="server-state"></p>
            <hr>
            <p>5分ごとにサーバーを監視し、エラーが起きた場合は再起動しています。</p>
        </section>
        <section>
            <h2>サーバーの仕様</h2>
            <p><img src="https://img.shields.io/badge/-Node.js-339933.svg?logo=node.js&style=for-the-badge&logoColor=ffffff">で動かしており、ファイル一覧の公開は<img src="https://img.shields.io/badge/Python-Flask-3776AB.svg?logo=python&style=for-the-badge&logoColor=ffffff">で行っています。</p>
            <h3>エラーの種類と対処法</h3>
            <h4>511 Network Authentication Required</h4>
            <p>ページ上部の認証をしてください。一週間に一度程度要求される場合があります。</p>
            <h4>502 Bad Gateway</h4>
            <p>再読み込みしてください。再起動中かもしれません。</p>
            <h4>fetch error</h4>
            <p>時間割画像の取得に失敗しました。再読み込みしてください。また、サーバー側の障害の場合もあるので時間を開けてもう一度お試しください。</p>
        </section>
    </main>

    <footer>
        <p>© 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p>
            <a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>
    <script>
        const timetable = document.getElementById("timetable");
        timetable.style.display = "none";
        timetable.insertAdjacentHTML("afterend", "<span>読み込み中…</span>");

        (async () => {
            const container = document.getElementById("past-timetable");
            const baseURL = "https://mito1-website.loca.lt/files/";
            const timetable = document.getElementById("timetable");

            // 進捗表示
            const progress = document.createElement("p");
            progress.textContent = "0% / 100% 処理中…";
            const progressBar = document.createElement("progress");
            progressBar.value = 0;
            progressBar.max = 100;
            container.appendChild(progress, progressBar);

            async function fetchBlob(url) {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Failed to fetch ${url}`);
                const blob = await res.blob();
                return URL.createObjectURL(blob);
            }

            // 今日の日付 yyyymmdd
            const today = new Date();
            const ymd =
                today.getFullYear().toString() +
                String(today.getMonth() + 1).padStart(2, "0") +
                String(today.getDate()).padStart(2, "0");

            try {
                const res = await fetch(baseURL + "images.json");
                const data = await res.json();
                const files = data.files.slice().sort().reverse();

                if (!files.length) {
                    container.textContent = "画像が見つかりません。";
                    return;
                }

                // ▼ 今日の画像をすべて取得
                const todayFiles = files.filter(f => f.startsWith(ymd));

                console.log({ files})
                console.log({ todayFiles });

                // 表示対象
                const displayFiles = todayFiles.length ? todayFiles : [files[0]];

                // 既存 single img を隠す
                timetable.style.display = "none";
                if (timetable.nextElementSibling) timetable.nextElementSibling.remove();

                // 表示用ラッパー
                const todayWrapper = document.createElement("div");
                todayWrapper.style.cssText = "display:flex; flex-wrap:wrap; gap:12px;";
                timetable.parentNode.appendChild(todayWrapper);

                for (const file of displayFiles) {
                    const blobURL = await fetchBlob(baseURL + file);

                    const img = document.createElement("img");
                    img.src = blobURL;
                    img.alt = file;
                    img.style.cssText = "max-width:100%; border-radius:8px";

                    todayWrapper.appendChild(img);
                }

                // ▼ 過去画像
                const otherFiles = files.filter(f => !displayFiles.includes(f));

                for (let i = 0; i < otherFiles.length; i++) {
                    const file = otherFiles[i];
                    const blobURL = await fetchBlob(baseURL + file);

                    const link = document.createElement("a");
                    link.href = blobURL;
                    link.target = "_blank";
                    link.rel = "noopener noreferrer";

                    const imgWrapper = document.createElement("div");
                    imgWrapper.style.cssText =
                        "display:block; margin-bottom:12px; cursor:pointer; position:relative; width:fit-content;";

                    const img = document.createElement("img");
                    img.src = blobURL;
                    img.alt = file;
                    img.loading = "lazy";
                    img.style.cssText =
                        "max-width:300px; display:block; border-radius:8px; margin-bottom:12px";

                    const filelabel = document.createElement("span");
                    filelabel.textContent = file;
                    filelabel.style.cssText =
                        "position:absolute; top:0; right:0; background:rgba(0,0,0,0.6); color:#fff; font-size:10px; padding:2px 4px; border-bottom-left-radius:4px";

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(filelabel);
                    link.appendChild(imgWrapper);
                    container.appendChild(link);

                    const percent = Math.floor(((i + 1) / otherFiles.length) * 100);
                    progress.textContent = `${percent}% / 100% 処理中…`;
                    progressBar.value = percent;
                }

                progress.remove();
                progressBar.remove();

            } catch (e) {
                container.textContent = "画像一覧の取得に失敗しました。";
                console.error(e);
            }
        })();

        // ▼ server-state.json を読み込み、状態とルートアクセス結果を表示
        (function () {
            const stateSpan = document.getElementById("server-state");
            const stateURL = "https://mito1-website.loca.lt/files/server-state.json";
            const rootURL = "https://mito1-website.loca.lt/";

            Promise.all([
                fetch(stateURL).then(res => res.json()).catch(() => null),
                fetch(rootURL, { method: "GET" })
                    .then(r => ({ ok: true, status: r.status, statusText: r.statusText }))
                    .catch(err => ({ ok: false, error: err.toString() }))
            ])
                .then(([data, rootStatus]) => {
                    const results = [];

                    // ▼ server-state.json 側
                    if (!data || !Array.isArray(data.services)) {
                        results.push("server-state.json: 取得失敗");
                    } else {
                        const svcTexts = data.services.map(svc => {
                            const name = svc.name || "unknown";
                            const active = svc.ActiveState || "unknown";
                            let dispname = name;

                            switch (name) {
                                case "update-timetable":
                                    dispname = '時間割取得プログラム';
                                    break;
                                case "update_timetable":
                                    dispname = '時間割公開プログラム';
                                    break;
                                case 'update-timetable-tunnel':
                                    dispname = 'サーバートンネルプログラム';
                                    break;
                            }

                            return `${dispname}: ${active}`;
                        });
                        results.push(...svcTexts);
                    }

                    // ▼ ルート URL のステータス
                    if (rootStatus.ok) {
                        results.push(`サーバー状況: ${rootStatus.status} ${rootStatus.statusText}`);
                    } else {
                        results.push(`サーバー状況: エラー (${rootStatus.error})`);
                    }

                    stateSpan.innerHTML = results.join("<br>");
                })
                .catch(() => {
                    stateSpan.textContent = "取得失敗";
                });
        })();

        // 検索
        document.getElementById("search-btn").addEventListener("click", function () {
            const query = document.getElementById("search-box").value.trim().toLowerCase();
            const pastTimetable = document.getElementById("past-timetable");
            const items = pastTimetable.querySelectorAll("div > div");

            items.forEach(function (item) {
                const text = item.innerHTML.trim().toLowerCase();
                item.style.display = text.includes(query) ? "" : "none";
            });
        });

        document.getElementById("search-box").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                document.getElementById("search-btn").click();
            }
        });
    </script>
    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script type="module" src="../script/restriction.js"></script>
    <script type="module" src="../script/notification.js"></script>
    <script src="../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>