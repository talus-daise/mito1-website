<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>トップぺージ | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../timetable/"><i class="fa-solid fa-table"></i>時間割一覧</a>
        </p>
    </header>

    <main>
        <section>
            <h2>現在の時間割画像</h2>
            <img src="" alt="時間割画像" id="timetable">
            <p>※もし画像が表示されない場合は、一度<a href="https://rebecka-unchilled-lisandra.ngrok-free.dev/">こちら</a>にアクセスしてください。</p>
        </section>
        <section class="main__classlist">
            <h2>時間割スプレッドシート</h2>
            <iframe src="https://docs.google.com/spreadsheets/d/1fdSGqT1s2kit91TcQV_mjcuvOawGAU6JZ_5N684bH3U/htmlview"
                title="時間割">
            </iframe>
            <br>
            <a href="https://drive.google.com/drive/u/0/folders/1vCjJklOsTeYBcyQ7P4eJNBuCE1VvzvF8" target="_blank"
                rel="noopener noreferrer">Google Driveで過去の時間割を見る</a>
        </section>
        <section>
            <h2>過去の時間割一覧</h2>
            <label for="search-box">検索：<input type="text" id="search-box" placeholder="時間割を検索..."></label>
            <button id="search-btn">検索</button>
            <button id="search-help" class="help-button"><i class="fa-solid fa-circle-question"></i></button>
            <p>※自動生成のため、実際とは違う日付になっている可能性があります。現在修正中ですので少々お待ちください。</p>
            <div id="past-timetable">読み込み中…</div>
        </section>
    </main>

    <footer>
        <p>© 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p>
            <a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>
    <script>
        (async () => {
            const container = document.getElementById("past-timetable");
            const baseURL = "https://rebecka-unchilled-lisandra.ngrok-free.dev/";

            function makeHeaders(user, pass) {
                const token = btoa(`${user}:${pass}`);
                return {
                    Authorization: `Basic ${token}`,
                    'ngrok-skip-browser-warning': 'true',
                    'User-Agent': 'CustomClient/1.0',
                };
            }

            async function extractDateFromImage(blob) {
                return new Promise((resolve) => {
                    const img = new Image();
                    const reader = new FileReader();
                    reader.onload = () => {
                        img.onload = async () => {
                            const canvas = document.createElement("canvas");
                            const ctx = canvas.getContext("2d");

                            // 左上 2.5×1cm （28×21cm全体に対して）
                            const ratioX = 2.5 / 28;
                            const ratioY = 1 / 21;
                            const cropWidth = img.width * ratioX;
                            const cropHeight = img.height * ratioY;
                            const startX = img.width / 2 + 10;
                            const startY = 10;

                            // クロップ領域を一旦切り出し
                            const cropCanvas = document.createElement("canvas");
                            cropCanvas.width = cropWidth;
                            cropCanvas.height = cropHeight;
                            const cropCtx = cropCanvas.getContext("2d");
                            cropCtx.drawImage(img, startX, startY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

                            // ★ 横方向を2.0倍に拡大
                            const stretchX = 3.0;
                            const stretchY = 2.0;
                            canvas.width = cropWidth * stretchX;
                            canvas.height = cropHeight * stretchY;
                            ctx.drawImage(cropCanvas, 0, 0, canvas.width, canvas.height);

                            // 白黒化処理（OCR前処理）
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;
                            for (let i = 0; i < data.length; i += 4) {
                                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                                const value = avg > 140 ? 255 : 0; // 明暗しきい値
                                data[i] = data[i + 1] = data[i + 2] = value;
                            }
                            ctx.putImageData(imageData, 0, 0);

                            // ★ 白黒化結果をBlobとして出力
                            const processedBlob = await new Promise((res) => canvas.toBlob(res, "image/png"));
                            const processedURL = URL.createObjectURL(processedBlob);

                            // // ★ プレビュー表示（必要なら削除可）
                            // const preview = document.createElement("img");
                            // preview.src = processedURL;
                            // preview.alt = "OCR対象領域（横1.3倍拡大済み）";
                            // preview.style.display = "block";
                            // preview.style.border = "1px solid #ccc";
                            // preview.style.margin = "8px 0";
                            // preview.style.maxWidth = "300px";
                            // document.body.appendChild(preview);

                            // OCR実行
                            const { createWorker } = Tesseract;
                            const worker = await createWorker("jpn");
                            const { data: { text } } = await worker.recognize(canvas);
                            await worker.terminate();

                            // 日付＋曜日形式のみ抽出
                            const match = text.match(
                                /(\d{1,2})\s*[\/\.．－‐ー−―]\s*(\d{1,2})\s*[\(（]\s*[日月火水木金土]\s*[\)）]/
                            );

                            resolve({
                                text: match ? match[0].replace(/\s+/g, "") : text.trim() || "日付不明",
                                processedURL,
                            });
                        };
                        img.src = reader.result;
                    };
                    reader.readAsDataURL(blob);
                });
            }

            try {
                const response = await fetch(baseURL, {
                    headers: makeHeaders("talus", "talus"),
                    cache: "no-store",
                });

                if (!response.ok) throw new Error(`HTTPエラー: ${response.status}`);

                const html = await response.text();

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");

                const links = [...doc.querySelectorAll("a[href$='.jpg']")];
                if (links.length === 0) {
                    container.textContent = "画像が見つかりません。";
                    return;
                }

                const files = links.map(a => a.getAttribute("href")).sort().reverse();

                const timetable = document.getElementById("timetable");
                timetable.style.maxWidth = "calc(100% - 2rem)";
                const latestFile = files[0];
                const latestFileURL = baseURL + latestFile.replace(/^\//, "");
                const latestFileBlobResponse = await fetch(latestFileURL, {
                    headers: makeHeaders("talus", "talus"),
                    cache: "no-store",
                });
                if (latestFileBlobResponse.ok) {
                    const latestBlob = await latestFileBlobResponse.blob();
                    const latestBlobURL = URL.createObjectURL(latestBlob);
                    timetable.src = latestBlobURL;
                    timetable.alt = `最新の時間割画像 (${latestFile})`;
                } else {
                    console.warn(`最新画像の取得に失敗しました: ${latestFileBlobResponse.status}`);
                    timetable.alt = "最新の時間割画像を取得できませんでした。";
                }

                const list = document.createElement("div");

                // 最新以外を処理
                for (const file of files.slice(1)) {
                    const li = document.createElement("div");
                    const url = baseURL + file.replace(/^\//, "");

                    // blob経由で画像を取得
                    try {
                        const imgResponse = await fetch(url, {
                            headers: makeHeaders("talus", "talus"),
                            cache: "no-store",
                        });
                        if (!imgResponse.ok) throw new Error(`画像取得エラー: ${imgResponse.status}`);
                        const blob = await imgResponse.blob();
                        const blobURL = URL.createObjectURL(blob);

                        // OCRで日付取得
                        const { text: dateText, processedURL } = await extractDateFromImage(blob);

                        // 日付表示
                        const name = document.createElement("span");
                        name.textContent = dateText;
                        name.style.fontWeight = "bold";
                        name.style.marginBottom = "4px";

                        // 表示用リンクと画像
                        const link = document.createElement("a");
                        link.href = blobURL;
                        link.target = "_blank";
                        link.rel = "noopener noreferrer";
                        link.title = file;

                        const img = document.createElement("img");
                        img.src = blobURL;
                        img.alt = file;
                        img.loading = "lazy";
                        img.style.maxWidth = "300px";
                        img.style.display = "block";
                        img.style.borderRadius = "8px";
                        img.style.marginBottom = "12px";
                        img.style.cursor = "pointer";

                        // 組み立て
                        link.appendChild(img);
                        li.appendChild(name);
                        li.appendChild(link);
                        list.appendChild(li);
                    } catch (e) {
                        console.warn(`${file} の画像取得に失敗しました:`, e);
                    }
                }

                container.innerHTML = "";
                container.appendChild(list);
            } catch (err) {
                console.error("画像一覧取得エラー:", err);
                container.textContent = "画像一覧の取得に失敗しました。";
            }
        })();

        document.getElementById("search-btn").addEventListener("click", () => {
            const query = document.getElementById("search-box").value.trim().toLowerCase();
            const pastTimetable = document.getElementById("past-timetable");
            const items = pastTimetable.querySelectorAll("div > div");

            items.forEach(item => {
                const text = item.innerHTML.trim().toLowerCase();
                if (text.includes(query)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        });

        document.getElementById("search-box").addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                document.getElementById("search-btn").click();
            }
        });

        document.getElementById("search-help").addEventListener("click", () => {
            showCustomAlert(
                "<b>検索機能のヒント</b><br>" +
                "・キーワードは部分一致で検索されます。<br>" +
                "・時間割画像は前日に更新されることが多いです。<br>" +
                "・ファイル名は更新日時なので、一日前や、月曜日だったら金曜日の日にちで検索してみてもいいでしょう。<br>" +
                "・ファイル名の形式はYYYYMMDD-hhmmss-index.jpgです。<br>例: 20240219-123129-1.jpg<br>" +
                "・以上の形式で検索すると見つかるかもしれません。"
            );
        });
    </script>
    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script src="../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>