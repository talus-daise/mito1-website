<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>トップぺージ | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../timetable/"><i class="fa-solid fa-table"></i>時間割一覧</a>
        </p>
    </header>

    <main>
        <section>
            <h2>現在の時間割画像</h2>
            <img src="" alt="時間割画像" id="timetable" width="calc(100% - 2rem)">
        </section>
        <section class="main__classlist">
            <h2>時間割スプレッドシート</h2>
            <iframe src="https://docs.google.com/spreadsheets/d/1fdSGqT1s2kit91TcQV_mjcuvOawGAU6JZ_5N684bH3U/htmlview"
                title="時間割">
            </iframe>
        </section>
        <section>
            <h2>過去の時間割一覧</h2>
            <label for="search-box">検索：<input type="text" id="search-box" placeholder="時間割をファイル名から検索..."></label>
            <button id="search-btn">検索</button>
            <div id="past-timetable"></div>
        </section>
        <section>
            <h2>サーバーの稼働状況</h2>
            <p id="server-state"></p>
            <hr>
            <p>5分ごとにサーバーを監視し、エラーが起きた場合は再起動しています。</p>
        </section>
    </main>

    <footer>
        <p>© 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p>
            <a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>
    <script>
        const timetable = document.getElementById("timetable");
        timetable.style.display = "none";
        timetable.insertAdjacentHTML("afterend", "<span>読み込み中…</span>");

        (async () => {
            const container = document.getElementById("past-timetable");
            const baseURL = "https://mito1-website.loca.lt/files/";
            const timetable = document.getElementById("timetable");

            // 進捗表示用要素作成
            const progress = document.createElement("p");
            progress.textContent = "0% / 100% 処理中…";
            const progressBar = document.createElement("progress");
            progressBar.value = 0;
            progressBar.max = 100;
            container.appendChild(progress);
            container.appendChild(progressBar);

            async function fetchBlob(url) {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Failed to fetch ${url}`);
                const blob = await res.blob();
                return URL.createObjectURL(blob);
            }

            try {
                const res = await fetch(baseURL + "images.json");
                const data = await res.json();
                const files = data.files.slice().sort().reverse();

                if (!files.length) {
                    container.textContent = "画像が見つかりません。";
                    return;
                }

                // 最新画像表示
                const latestFile = files[0];
                timetable.src = await fetchBlob(baseURL + latestFile);
                timetable.alt = "最新の時間割画像 (" + latestFile + ")";
                timetable.style.display = "block";
                timetable.style.width = "calc(100% - 2rem)";
                if (timetable.nextElementSibling) timetable.nextElementSibling.remove();

                // 過去画像リスト表示
                const list = document.createElement("div");
                const frag = document.createDocumentFragment();
                const otherFiles = files.slice(1);

                for (let i = 0; i < otherFiles.length; i++) {
                    const file = otherFiles[i];
                    const blobURL = await fetchBlob(baseURL + file);

                    const link = document.createElement("a");
                    link.href = blobURL;
                    link.target = "_blank";
                    link.rel = "noopener noreferrer";

                    const imgWrapper = document.createElement("div");
                    imgWrapper.style.cssText = "display:block; margin-bottom:12px; cursor:pointer; position:relative; width:fit-content;";

                    const img = document.createElement("img");
                    img.src = blobURL;
                    img.alt = file;
                    img.loading = "lazy";
                    img.style.cssText = "max-width:300px; display:block; border-radius:8px; margin-bottom:12px";

                    const filelabel = document.createElement("span");
                    filelabel.textContent = file;
                    filelabel.style.cssText = "position:absolute; top:0; right:0; background:rgba(0,0,0,0.6); color:#fff; font-size:10px; padding:2px 4px; border-bottom-left-radius:4px";

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(filelabel);
                    link.appendChild(imgWrapper);
                    frag.appendChild(link);

                    // 進捗更新
                    const percent = Math.floor(((i + 1) / otherFiles.length) * 100);
                    progress.textContent = `${percent}% / 100% 処理中…`;
                    progressBar.value = percent;
                }

                list.appendChild(frag);
                container.innerHTML = "";
                container.appendChild(list);

            } catch (e) {
                container.textContent = "画像一覧の取得に失敗しました。";
                console.error(e);
            }
        })();

        // ▼ server-state.json を読み込み、状態とルートアクセス結果を表示
        (function () {
            const stateSpan = document.getElementById("server-state");
            const stateURL = "https://mito1-website.loca.lt/files/server-state.json";
            const rootURL = "https://mito1-website.loca.lt/";

            Promise.all([
                fetch(stateURL).then(res => res.json()).catch(() => null),
                fetch(rootURL, { method: "GET" })
                    .then(r => ({ ok: true, status: r.status, statusText: r.statusText }))
                    .catch(err => ({ ok: false, error: err.toString() }))
            ])
                .then(([data, rootStatus]) => {
                    const results = [];

                    // ▼ server-state.json 側
                    if (!data || !Array.isArray(data.services)) {
                        results.push("server-state.json: 取得失敗");
                    } else {
                        const svcTexts = data.services.map(svc => {
                            const name = svc.name || "unknown";
                            const active = svc.ActiveState || "unknown";
                            let dispname = name;

                            switch (name) {
                                case "update-timetable":
                                    dispname = '時間割取得プログラム';
                                    break;
                                case "update_timetable":
                                    dispname = '時間割公開プログラム';
                                    break;
                                case 'update-timetable-tunnel':
                                    dispname = 'サーバートンネルプログラム';
                                    break;
                            }

                            return `${dispname}: ${active}`;
                        });
                        results.push(...svcTexts);
                    }

                    // ▼ ルート URL のステータス
                    if (rootStatus.ok) {
                        results.push(`サーバー状況: ${rootStatus.status} ${rootStatus.statusText}`);
                    } else {
                        results.push(`サーバー状況: エラー (${rootStatus.error})`);
                    }

                    stateSpan.innerHTML = results.join("<br>");
                })
                .catch(() => {
                    stateSpan.textContent = "取得失敗";
                });
        })();

        // 検索
        document.getElementById("search-btn").addEventListener("click", function () {
            const query = document.getElementById("search-box").value.trim().toLowerCase();
            const pastTimetable = document.getElementById("past-timetable");
            const items = pastTimetable.querySelectorAll("div > div");

            items.forEach(function (item) {
                const text = item.innerHTML.trim().toLowerCase();
                item.style.display = text.includes(query) ? "" : "none";
            });
        });

        document.getElementById("search-box").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                document.getElementById("search-btn").click();
            }
        });

        const isPageVisited = localStorage.getItem("isPageVisited");

        document.addEventListener("DOMContentLoaded", () => {
            if (isPageVisited === null) {
                const sect = document.createElement("section");
                sect.classList.add("highlight");

                const h2 = document.createElement("h2");
                h2.textContent = "注意";

                const p = document.createElement("p");
                p.innerHTML =
                    "時間割が見られないときは、以下の手順を踏んだ上、再読込してください。<br>" +
                    "1. <a href='https://mito1-website.loca.lt/' target='_blank' rel='noopener noreferrer'>このリンク</a>に飛ぶ<br>" +
                    "2. パスワード欄に`106.73.192.65`を入力する<br>" +
                    "3. submitを押す<br>" +
                    "4. ファイル一覧が表示されたら成功→名簿と時間割が表示されるようになります。";

                sect.append(h2, p);
                document.querySelector("main").insertAdjacentElement("afterbegin", sect);

                localStorage.setItem("isPageVisited", "true");
            }
        });
    </script>
    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script src="../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>