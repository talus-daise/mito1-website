<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>トップぺージ | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../timetable/"><i class="fa-solid fa-table"></i>時間割一覧</a>
        </p>
    </header>

    <main>
        <section>
            <h2>現在の時間割画像</h2>
            <img src="" alt="時間割画像" id="timetable" width="calc(100% - 2rem)">
        </section>
        <section class="main__classlist">
            <h2>時間割スプレッドシート</h2>
            <iframe src="https://docs.google.com/spreadsheets/d/1fdSGqT1s2kit91TcQV_mjcuvOawGAU6JZ_5N684bH3U/htmlview"
                title="時間割">
            </iframe>
        </section>
        <section>
            <h2>過去の時間割一覧</h2>
            <label for="search-box">検索：<input type="text" id="search-box" placeholder="時間割を検索..."></label>
            <button id="search-btn">検索</button>
            <button id="search-help" class="help-button"><i class="fa-solid fa-circle-question"></i></button>
            <p>※自動生成のため、実際とは違う日付になっている可能性があります。現在修正中ですので少々お待ちください。</p>
            <div id="past-timetable"></div>
        </section>
        <section>
            <h2>サーバーの稼働状況</h2>
            <p>状態: <span id="server-state"></span></p>
            <p></p>
        </section>
    </main>

    <footer>
        <p>© 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p>
            <a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>
    <script>
        const timetable = document.getElementById("timetable");
        timetable.style.display = "none";
        timetable.insertAdjacentHTML("afterend", "<span>読み込み中…</span>");

        (function () {
            const container = document.getElementById("past-timetable");
            const baseURL = "https://mito1-website.loca.lt/";

            function get(url, callback) {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        callback(xhr.status, xhr.responseText);
                    }
                };
                xhr.send();
            }

            function getBlob(url, callback) {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                xhr.responseType = "blob";
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        callback(xhr.status, xhr.response);
                    }
                };
                xhr.send();
            }

            get(baseURL, function (status, html) {
                if (status !== 200) {
                    container.textContent = "画像一覧の取得に失敗しました。";
                    return;
                }

                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const links = [].slice.call(doc.querySelectorAll("a[href$='.jpg']"));

                if (links.length === 0) {
                    container.textContent = "画像が見つかりません。";
                    return;
                }

                const files = links.map(function (a) {
                    return a.getAttribute("href");
                }).sort().reverse();

                const latestFile = files[0];
                const latestFileURL = baseURL + latestFile.replace(/^\//, "");

                getBlob(latestFileURL, function (st, blob) {
                    if (st === 200) {
                        const blobURL = URL.createObjectURL(blob);
                        timetable.src = blobURL;
                        timetable.alt = "最新の時間割画像 (" + latestFile + ")";
                        timetable.style.display = "block";
                        timetable.nextElementSibling.remove();
                    }
                });

                const list = document.createElement("div");
                const pastTimetable = document.getElementById("past-timetable");
                const progress = document.createElement("p");
                progress.textContent = "処理中…";
                pastTimetable.appendChild(progress);

                const otherFiles = files.slice(1);
                let index = 0;

                function processNext() {
                    if (index >= otherFiles.length) {
                        container.innerHTML = "";
                        container.appendChild(list);
                        return;
                    }

                    const file = otherFiles[index];
                    const fileURL = baseURL + file.replace(/^\//, "");

                    getBlob(fileURL, function (st, blob) {
                        if (st === 200) {
                            const blobURL = URL.createObjectURL(blob);

                            const li = document.createElement("div");

                            const name = document.createElement("span");
                            name.textContent = file;
                            name.style.fontWeight = "bold";
                            name.style.marginBottom = "4px";

                            const link = document.createElement("a");
                            link.href = blobURL;
                            link.target = "_blank";
                            link.rel = "noopener noreferrer";

                            const imgWrapper = document.createElement("div");
                            imgWrapper.style.display = "block";
                            imgWrapper.style.marginBottom = "12px";
                            imgWrapper.style.cursor = "pointer";
                            imgWrapper.style.position = "relative";

                            const img = document.createElement("img");
                            img.src = blobURL;
                            img.alt = file;
                            img.loading = "lazy";
                            img.style.maxWidth = "300px";
                            img.style.display = "block";
                            img.style.borderRadius = "8px";
                            img.style.marginBottom = "12px";

                            const filelabel = document.createElement("span");
                            filelabel.textContent = file;
                            filelabel.style.position = "absolute";
                            filelabel.style.top = "0";
                            filelabel.style.right = "0";
                            filelabel.style.backgroundColor = "rgba(0,0,0,0.6)";
                            filelabel.style.color = "#fff";
                            filelabel.style.fontSize = "10px";
                            filelabel.style.padding = "2px 4px";
                            filelabel.style.borderBottomLeftRadius = "4px";

                            imgWrapper.appendChild(img);
                            imgWrapper.appendChild(filelabel);
                            link.appendChild(imgWrapper);
                            li.appendChild(name);
                            li.appendChild(link);
                            list.appendChild(li);
                        }

                        index++;
                        processNext();
                    });
                }

                processNext();
            });
        })();

        document.getElementById("search-btn").addEventListener("click", function () {
            const query = document.getElementById("search-box").value.trim().toLowerCase();
            const pastTimetable = document.getElementById("past-timetable");
            const items = pastTimetable.querySelectorAll("div > div");

            items.forEach(function (item) {
                const text = item.innerHTML.trim().toLowerCase();
                item.style.display = text.includes(query) ? "" : "none";
            });
        });

        document.getElementById("search-box").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                document.getElementById("search-btn").click();
            }
        });

        document.getElementById("search-help").addEventListener("click", function () {
            showCustomAlert(
                "<b>検索機能のヒント</b><br>" +
                "・キーワードは部分一致で検索されます。<br>" +
                "・時間割画像は前日に更新されることが多いです。<br>" +
                "・ファイル名は更新日時なので、日付で検索すると見つかる場合があります。<br>" +
                "・形式は YYYYMMDD-hhmmss-index.jpg です。"
            );
        });
    </script>
    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script src="../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>