<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>時間割 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../script/notice/notice.css">
    <style>
        #timetable-img {
            border-radius: 8px;
            width: calc(100% - 2rem);
            display: block;
            margin: 1rem;
        }

        #past-timetable {
            margin: 0 1rem;
        }

        #past-timetable img {
            max-width: 100%;
            border-radius: 8px;
            display: block;
        }

        #past-timetable a::after {
            content: "";
            display: block;
            clear: both;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../manifest.json">
</head>

<body>
    <header>
        <h1><a href="../">水戸一高附属中総合ウェブサイト</a></h1>
        <p class="header__breadcrumb">
            <a href="../"><i class="fa-solid fa-house"></i>トップページ</a>
            <a href="../timetable/"><i class="fa-solid fa-table"></i>時間割一覧</a>
        </p>
    </header>

    <main>
        <section>
            <h2>現在の時間割画像</h2>
            <img src="" alt="時間割画像" id="timetable-img" width="calc(100% - 2rem)">
        </section>
        <section class="main__classlist">
            <h2>時間割スプレッドシート</h2>
            <iframe src="https://docs.google.com/spreadsheets/d/1fdSGqT1s2kit91TcQV_mjcuvOawGAU6JZ_5N684bH3U/htmlview"
                title="時間割">
            </iframe>
        </section>
        <section>
            <h2>お詫び</h2>
            <p>サーバー関係の不具合で、2025-12-09〜2025-12-16の時間割が保存されていなかったことに現在(2025-12-18)気が付きました…^^;</p>
            <p>そもそも保存がされていなかったようなので、残念ながら閲覧することができません…</p>
            <p>ご不便をおかけして申し訳ありません。</p>
            <hr>
            <p>追記！</p>
            <p>なぜか知らんけど2025-02-03~2025-02-10までも保存されてなかった…</p>
            <p>こちらも申し訳ありませんが閲覧できません…</p>
        </section>
        <section>
            <h2>過去の時間割一覧</h2>
            <p><label for="search-box">検索：<input type="text" id="search-box" placeholder="時間割をファイル名から検索..."></label>
                <button id="search-btn">検索</button>
            </p>
            <div id="past-timetable"></div>
        </section>
        <section>
            <h2>サーバーの稼働状況</h2>
            <div id="server-state"></div>
            <hr>
            <p>5分ごとにサーバーを監視し、エラーが起きた場合は再起動しています。</p>
        </section>
        <section>
            <h2>サーバーの仕様</h2>
            <p><img
                    src="https://img.shields.io/badge/Python-3776AB.svg?logo=python&style=for-the-badge&logoColor=ffffff">で動かしています。
            </p>
            <h3>fetch error</h3>
            <p>時間割画像の取得に失敗しました。再読み込みしてください。また、サーバー側の障害の場合もあるので時間を開けてもう一度お試しください。</p>
        </section>
    </main>

    <footer>
        <p>© 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p>
            <a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>
    <script>
        const BASE_URL = "https://talus-daise.github.io/mito1-website-timetable/output/";
        const JSON_URL = BASE_URL + "images.json";

        const timetableImg = document.getElementById("timetable-img");
        timetableImg.style.display = "none";
        timetableImg.insertAdjacentHTML("afterend", "<span id='loading'>読み込み中…</span>");

        // YYYYMMDD-HHMMSS / YYYYMMDD-1 対応
        function parseFilename(name) {
            const m = name.match(/^(\d{8})(?:-(\d{6})|-(\d+))\.(jpg|png)$/i);
            if (!m) return null;

            const [, ymd, time, indexOnly] = m;
            const y = ymd.slice(0, 4);
            const mo = ymd.slice(4, 6);
            const d = ymd.slice(6, 8);

            let hh = "00", mm = "00", ss = "00";
            let index = 0;

            if (time) {
                hh = time.slice(0, 2);
                mm = time.slice(2, 4);
                ss = time.slice(4, 6);
            } else if (indexOnly) {
                index = Number(indexOnly);
            }

            return {
                filename: name,
                url: BASE_URL + name,
                date: new Date(`${y}-${mo}-${d}T${hh}:${mm}:${ss}Z`),
                dateKey: `${y}-${mo}-${d}`,
                index
            };
        }

        let isPastLoaded = false;

        async function loadTimetable() {
            const pastContainer = document.getElementById("past-timetable");

            const progress = document.createElement("p");
            progress.textContent = "0% / 100% 処理中…";
            const bar = document.createElement("progress");
            bar.max = 100;
            bar.value = 0;

            if (!isPastLoaded) {
                pastContainer.insertAdjacentElement("beforebegin", progress, bar);
            }

            try {
                const res = await fetch(JSON_URL);
                if (!res.ok) throw new Error("images.json 取得失敗");

                const json = await res.json();
                const files = json.files
                    .map(parseFilename)
                    .filter(Boolean)
                    .sort((a, b) => (b.date - a.date) || (b.index - a.index));

                if (!files.length) throw new Error("画像なし");

                const latestDateKey = files[0].dateKey;
                const todayFiles = files
                    .filter(f => f.dateKey === latestDateKey)
                    .sort((a, b) => (a.index - b.index) || (a.date - b.date));

                document.getElementById("loading")?.remove();

                for (const f of todayFiles) {
                    const img = document.getElementById("timetable-img");
                    img.src = f.url;
                    img.alt = f.filename;
                    img.style.cssText = "max-width:100%; border-radius:8px";
                }

                if (isPastLoaded) return;

                // ▼ 過去分
                const others = files.filter(f => f.dateKey !== latestDateKey);

                for (let i = 0; i < others.length; i++) {
                    const f = others[i];

                    const link = document.createElement("a");
                    link.href = f.url;
                    link.target = "_blank";
                    link.rel = "noopener noreferrer";

                    const box = document.createElement("div");
                    box.style.cssText =
                        "display:block; margin-bottom:12px; position:relative; width:fit-content;";

                    const img = document.createElement("img");
                    img.src = f.url;
                    img.loading = "lazy";
                    img.style.cssText =
                        "max-width:300px; border-radius:8px; display:block;";

                    const label = document.createElement("span");
                    label.textContent = f.filename;
                    label.style.cssText =
                        "position:absolute; top:0; right:0; background:rgba(0,0,0,.6); color:#fff; font-size:10px; padding:2px 4px; border-top-right-radius:8px;";

                    box.append(img, label);
                    link.appendChild(box);
                    pastContainer.appendChild(link);

                    const percent = Math.floor(((i + 1) / others.length) * 100);
                    bar.value = percent;
                    progress.textContent = `${percent}% / 100% 処理中…`;
                }

                progress.remove();
                bar.remove();

                isPastLoaded = true;
            } catch (e) {
                console.error(e);
                pastContainer.textContent = "画像一覧の取得に失敗しました。";
            }
        }

        loadTimetable()

        setInterval(loadTimetable, 1000);

        (async () => {
            const serverStateEl = document.getElementById("server-state");
            try {
                const res = await fetch("https://talus-daise.github.io/mito1-website-timetable/output/server-state.json");
                if (!res.ok) throw new Error("サーバーステータス取得失敗");

                const json = await res.json();
                const service = json.services?.[0];
                const timetable_sync = json.timetable_sync;

                const p = document.createElement("p");
                p.textContent = `最終更新日時: ${new Date(json.generated_at).toLocaleString()}`;

                const status = document.createElement("p");
                status.textContent = `現在のサーバーステータス: ${service?.is_active ?? "unknown"}`;

                const latestSync = document.createElement("p");
                latestSync.textContent = `最後の時間割同期: ${timetable_sync?.synced_at ? new Date(timetable_sync.synced_at).toLocaleString() : "unknown"}`;

                const syncStatus = document.createElement("p");
                syncStatus.textContent = `同期状況: ${timetable_sync?.images_synced ?? "unknown"}`;

                serverStateEl.innerHTML = "";
                serverStateEl.appendChild(p);
                serverStateEl.appendChild(status);
                serverStateEl.appendChild(latestSync);
                serverStateEl.appendChild(syncStatus);
            } catch (e) {
                console.error(e);
                serverStateEl.textContent = "サーバーステータスの取得に失敗しました。";
            }
        })();

        // 検索
        document.getElementById("search-btn").addEventListener("click", () => {
            const q = document.getElementById("search-box").value.toLowerCase();
            document.querySelectorAll("#past-timetable div").forEach(el => {
                el.style.display = el.textContent.toLowerCase().includes(q) ? "" : "none";
            });
        });

        document.getElementById("search-box").addEventListener("keydown", e => {
            if (e.key === "Enter") document.getElementById("search-btn").click();
        });
    </script>
    <script type="module" src="../script/notice/notice.js"></script>
    <script src="../script/customAlert.js" type="module"></script>
    <script type="module" src="../script/restriction.js"></script>
    <script type="module" src="../script/notification.js"></script>
    <script src="../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>