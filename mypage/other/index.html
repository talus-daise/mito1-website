<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>マイページ | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <style>
        .user-info {
            width: 100%;
            display: inline-flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .user-info p {
            display: block;
            width: calc(100% - 10rem);
        }

        .user-info .user-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin-left: 1rem;
        }

        .user-info img {
            border-radius: 50%;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        #user-avatar {
            border: 1px solid #ccc;
            margin: 0 0 0 1.5rem;
        }

        .post {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .post h3 {
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }

        .post p {
            margin: 0.3rem 0;
            font-size: 0.9rem;
        }

        .post a {
            text-decoration: none;
            color: #3498db;
        }

        .post a:hover {
            text-decoration: underline;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/" type="module"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1>とある水戸一の名無し のマイページ</h1>
    </header>
    <main>
        <a href="../../">トップページに戻る</a>
        <div id="error-message" style="color: red; font-weight: bold;"></div>
        <section>
            <h2>ユーザー情報</h2>
            <div class="user-info">
                <img id="user-avatar" alt="ユーザーアイコン" width="50" height="50"><p class="user-name"><span id="display-name">とある水戸一の名無し</span></p>
                <p class="student-id"><i class="fa-solid fa-address-card"></i><span id="student-id">0X00</span></p>
                <p><i class="fa-solid fa-school"></i><span id="user-name">とある水戸一の名無し</span></p>
                <p class="user-email"><i class="fa-solid fa-envelope"></i><span id="user-email">guest@example.com</span></p>
            </div>
        </section>
        <section>
            <h2>私について</h2>
            <p id="about-me">自己紹介は未設定です。</p>
        </section>
        <section>
            <h2>ユーザー統計</h2>
            <div class="stats">
                <p><i class="fa-solid fa-door-open" title="訪問回数"></i> <span id="visit-count">0</span></p>
                <p><i class="fa-solid fa-pencil" title="投稿回数"></i> <span id="post-count">0</span></p>
            </div>
        </section>

        <section>
            <h2>掲示板の投稿一覧</h2>
            <div id="thread-list" class="content-list"></div>
        </section>

        <section>
            <h2>投稿した質問一覧</h2>
            <div id="question-list" class="content-list"></div>
        </section>

        <section>
            <h2>投稿した回答一覧</h2>
            <div id="answer-list" class="content-list"></div>
        </section>
    </main>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        let isLoading = true;

        const requiredUser = new URLSearchParams(window.location.search).get("user_id");
        const errorDiv = document.getElementById("error-message");

        if (!requiredUser) {
            errorDiv.textContent = "ユーザーが指定されていません。URLにuser_idパラメータを付与してください。";
            document.querySelector("main").style.display = "block";
            document.querySelector("h1").textContent = "マイページ";
            document.getElementById('custom-alert')?.remove();
        } else {
            document.addEventListener("DOMContentLoaded", async () => {
                await new Promise(resolve => {
                    showCustomAlert("読み込み中です", false);
                    resolve();
                });

                // 最新ユーザーデータ再取得
                const { data: user } = await supabase
                    .from("users")
                    .select("*")
                    .eq("user_id", requiredUser)
                    .single();

                if (!user) {
                    errorDiv.textContent = "ユーザーが存在しません。もしくはアップデート前に登録されたものです。";
                    document.querySelector("main").style.display = "block";
                    document.querySelector("h1").textContent = "マイページ";
                    document.getElementById('custom-alert').remove();
                } else {
                    document.title = `${user.display_name || "とある水戸一の名無し"} のマイページ | 水戸一高附属中総合ウェブサイト`;

                    // --- 学籍番号取得 ---
                    fetch("/mito1-website/private/names.json")
                        .then(response => response.json())
                        .then(data => {
                            const classes = Object.keys(data);
                            let studentId = "0A00";

                            for (const cls of classes) {
                                const index = data[cls].indexOf(user.full_name);
                                console.log("Checking class:", cls, "Index:", index);
                                console.log(user.user_name);
                                if (index !== -1) {
                                    const classCode = cls;
                                    const attendanceNumber = (index + 1).toString().padStart(2, '0');
                                    studentId = classCode + attendanceNumber;
                                    console.log("Found student ID:", studentId);
                                    break;
                                }
                            }

                            document.getElementById("student-id").textContent = studentId;
                        })
                        .catch(error => {
                            console.error("Error fetching names.json:", error);
                        });

                    document.querySelector("h1").textContent = `${user.display_name || "とある水戸一の名無し"} のマイページ`;
                    document.getElementById("user-avatar").src = user.avatar_url || "../../img/default-avatar.png";
                    document.getElementById("display-name").textContent = user.display_name || "ゲスト";
                    document.getElementById("user-name").textContent = user.full_name || "とある水戸一の名無し";
                    document.getElementById("user-email").textContent = textMosaic(user.user_email);
                    document.getElementById("about-me").textContent = user.about_me || "自己紹介は未設定です。";
                    document.getElementById("visit-count").textContent = user.visit_count;
                    document.getElementById("post-count").textContent = user.post_count;

                    // --- 質問一覧を取得 ---
                    const { data: questions } = await supabase
                        .from("questions")
                        .select("id, title, created_at, username")
                        .eq("user_email", user.user_email)
                        .order("created_at", { ascending: false });

                    const qList = document.getElementById("question-list");
                    questions?.forEach(q => {
                        const div = document.createElement("div");
                        div.classList.add("content-list-item");
                        const a = document.createElement("a");
                        a.href = `/mito1-website/question/details/?id=${q.id}`;
                        a.style.color = "inherit";
                        const title = document.createElement("h3");
                        title.textContent = q.title;
                        a.appendChild(title);
                        const time = document.createElement("p");
                        time.innerHTML = `<i class="fa-solid fa-clock"></i>${new Date(q.created_at).toLocaleString()}`;
                        a.appendChild(time);
                        const username = document.createElement("p");
                        username.innerHTML = `<i class="fa-solid fa-user"></i>${q.username}`;
                        a.appendChild(username);
                        div.appendChild(a);
                        qList.appendChild(div);
                    });

                    // --- 掲示板の投稿一覧を取得 ---
                    const { data: threads } = await supabase
                        .from("BBS")
                        .select("id, thread, title, created_at, username")
                        .eq("user_email", user.user_email)
                        .order("created_at", { ascending: false });

                    const tList = document.getElementById("thread-list");
                    threads?.forEach(t => {
                        const div = document.createElement("div");
                        div.classList.add("content-list-item");
                        const a = document.createElement("a");
                        a.href = `/mito1-website/bbs/thread/?thread=${encodeURIComponent(t.thread)}&post_id=${encodeURIComponent(t.id)}`;
                        a.style.color = "inherit";
                        const title = document.createElement("h3");
                        title.textContent = t.title;
                        a.appendChild(title);
                        const time = document.createElement("p");
                        time.innerHTML = `<i class="fa-solid fa-clock"></i>${new Date(t.created_at).toLocaleString()}`;
                        a.appendChild(time);
                        const username = document.createElement("p");
                        username.innerHTML = `<i class="fa-solid fa-user"></i>${t.username}`;
                        a.appendChild(username);
                        div.appendChild(a);
                        tList.appendChild(div);
                    });

                    // --- 回答一覧を取得 ---
                    const { data: answers } = await supabase
                        .from("answers")
                        .select("id, question_id, content, created_at, username")
                        .eq("user_email", user.user_email)
                        .order("created_at", { ascending: false });

                    const aList = document.getElementById("answer-list");
                    answers?.forEach(a => {
                        const div = document.createElement("div");
                        div.classList.add("content-list-item");
                        const aTag = document.createElement("a");
                        aTag.href = `/mito1-website/question/details/?id=${a.question_id}&answer_id=${a.id}`;
                        aTag.style.color = "inherit";
                        const content = document.createElement("h3");
                        content.textContent = a.content.slice(0, 20) + (a.content.length > 20 ? "..." : "");
                        aTag.appendChild(content);
                        const time = document.createElement("p");
                        time.innerHTML = `<i class="fa-solid fa-clock"></i>${new Date(a.created_at).toLocaleString()}`;
                        aTag.appendChild(time);
                        const username = document.createElement("p");
                        username.innerHTML = `<i class="fa-solid fa-user"></i>${a.username}`;
                        aTag.appendChild(username);
                        div.appendChild(aTag);
                        aList.appendChild(div);
                    });

                    isLoading = false;
                    document.getElementById('custom-alert').remove();

                    function textMosaic(str) {
                        return str.slice(0, 5) + "*".repeat(10) + str.slice(-5);
                    }
                }
            });
        }
    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>