<!DOCTYPE html>
<html lang="ja">

<head>
    <!--æ–‡å­—ã‚³ãƒ¼ãƒ‰ãƒ»äº’æ›ãƒ¢ãƒ¼ãƒ‰-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | æ°´æˆ¸ä¸€é«˜é™„å±ä¸­ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</title>
    <!--ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆ-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <style>
        .user-info {
            width: 100%;
            display: inline-flex;
            flex-direction: row;
            flex-wrap: wrap;
        }

        .user-info p {
            display: block;
            width: calc(100% - 10rem);
        }

        .user-info .user-name {
            font-weight: bold;
            font-size: 1.2rem;
            margin-left: 1rem;
        }

        .user-info img {
            border-radius: 50%;
        }

        .stats {
            display: flex;
            gap: 2rem;
        }

        #user-avatar {
            border: 1px solid #ccc;
            margin: 0 0 0 1.5rem;
        }

        .post {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .post h3 {
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }

        .post p {
            margin: 0.3rem 0;
            font-size: 0.9rem;
        }

        .post a {
            text-decoration: none;
            color: #3498db;
        }

        .post a:hover {
            text-decoration: underline;
        }
    </style>
    <!--webæƒ…å ±-->
    <meta name="keywords" content="æ°´æˆ¸ä¸€, æ°´æˆ¸ä¸€é™„å±, æ°´æˆ¸ä¸€é™„å±ä¸­, ä¸€å­¦å¹´,">
    <meta name="description" content="æ°´æˆ¸ä¸€é™„å±ä¸­ç”Ÿå‘ã‘ã®ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§ã™ã€‚é™„å±ä¸­å‘ã‘ã®æ²ç¤ºæ¿ã‚„è³ªå•ç®±ã‚’é‹å–¶ã—ã¦ã„ã¾ã™ã€‚">
    <meta name="author" content="Â©ï¸ 2025 talus">
    <!--æ›´æ–°æ—¥æ™‚-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--ã‚¢ã‚¤ã‚³ãƒ³-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/" type="module"></script>
    <!--ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1>ã¨ã‚ã‚‹æ°´æˆ¸ä¸€ã®åç„¡ã— ã®ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>
    </header>
    <main>
        <a href="#" id="backLink">æˆ»ã‚‹</a>
        <div id="error-message" style="color: red; font-weight: bold;"></div>
        <section>
            <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
            <div class="user-info">
                <img id="user-avatar" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³" width="50" height="50">
                <p class="user-name"><span id="display-name">ã¨ã‚ã‚‹æ°´æˆ¸ä¸€ã®åç„¡ã—</span></p>
                <p class="student-id"><i class="fa-solid fa-address-card"></i><span id="student-id">0X00</span></p>
                <p><i class="fa-solid fa-school"></i><span id="user-name">ã¨ã‚ã‚‹æ°´æˆ¸ä¸€ã®åç„¡ã—</span></p>
                <p class="user-email"><i class="fa-solid fa-envelope"></i><span id="user-email">guest@example.com</span>
                </p>
            </div>
        </section>
        <section>
            <h2>ç§ã«ã¤ã„ã¦</h2>
            <p id="about-me">è‡ªå·±ç´¹ä»‹ã¯æœªè¨­å®šã§ã™ã€‚</p>
        </section>
        <section>
            <h2>ãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆ</h2>
            <div class="stats">
                <p><i class="fa-solid fa-door-open" title="è¨ªå•å›æ•°"></i> <span id="visit-count">0</span></p>
                <p><i class="fa-solid fa-pencil" title="æŠ•ç¨¿å›æ•°"></i> <span id="post-count">0</span></p>
            </div>
        </section>

        <section>
            <h2>æ²ç¤ºæ¿ã®æŠ•ç¨¿ä¸€è¦§</h2>
            <div id="thread-list" class="content-list"></div>
        </section>

        <section>
            <h2>æŠ•ç¨¿ã—ãŸè³ªå•ä¸€è¦§</h2>
            <div id="question-list" class="content-list"></div>
        </section>

        <section>
            <h2>æŠ•ç¨¿ã—ãŸå›ç­”ä¸€è¦§</h2>
            <div id="answer-list" class="content-list"></div>
        </section>
    </main>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        let isLoading = true;

        const requiredUser = new URLSearchParams(window.location.search).get("user_id");
        const errorDiv = document.getElementById("error-message");

        if (!requiredUser) {
            errorDiv.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚URLã«user_idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚";
            document.querySelector("main").style.display = "block";
            document.querySelector("h1").textContent = "ãƒã‚¤ãƒšãƒ¼ã‚¸";
            document.getElementById('custom-alert')?.remove();
        } else {
            document.addEventListener("DOMContentLoaded", async () => {
                const redirectedURL = new URLSearchParams(window.location.search).get("redirect_url");

                const back = document.getElementById("backLink");

                back.href = redirectedURL ? redirectedURL : "../../";

                await new Promise(resolve => {
                    showCustomAlert("èª­ã¿è¾¼ã¿ä¸­ã§ã™", false);
                    resolve();
                });

                // æœ€æ–°ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å†å–å¾—
                const { data: user } = await supabase
                    .from("users")
                    .select("*")
                    .eq("user_id", requiredUser)
                    .single();

                if (!user) {
                    errorDiv.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ã‚‚ã—ãã¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆå‰ã«ç™»éŒ²ã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚";
                    document.querySelector("main").style.display = "block";
                    document.querySelector("h1").textContent = "ãƒã‚¤ãƒšãƒ¼ã‚¸";
                    document.getElementById('custom-alert').remove();
                } else {
                    document.title = `${user.display_name || "ã¨ã‚ã‚‹æ°´æˆ¸ä¸€ã®åç„¡ã—"} ã®ãƒã‚¤ãƒšãƒ¼ã‚¸ | æ°´æˆ¸ä¸€é«˜é™„å±ä¸­ç·åˆã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ`;

                    // --- å­¦ç±ç•ªå·å–å¾— ---
                    // ğŸ” studentsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å–å¾—
                    const { data: student, error } = await supabase
                        .from("students")
                        .select("student_id")
                        .eq("name", user.full_name)
                        .single();

                    if (error) {
                        console.error("Error fetching database:", error);
                        return;
                    };

                    const studentId = student?.student_id || "0A00";

                    document.getElementById("student-id").textContent = studentId;

                    document.querySelector("h1").textContent = `${user.display_name || "ã¨ã‚ã‚‹æ°´æˆ¸ä¸€ã®åç„¡ã—"} ã®ãƒã‚¤ãƒšãƒ¼ã‚¸`;
                    document.getElementById("user-avatar").src = user.avatar_url || "../../img/default-avatar.png";
                    document.getElementById("display-name").textContent = user.display_name || "ã‚²ã‚¹ãƒˆ";
                    document.getElementById("user-name").textContent = user.full_name || "ã¨ã‚ã‚‹æ°´æˆ¸ä¸€ã®åç„¡ã—";
                    document.getElementById("user-email").textContent = textMosaic(user.user_email);
                    document.getElementById("about-me").textContent = user.about_me || "è‡ªå·±ç´¹ä»‹ã¯æœªè¨­å®šã§ã™ã€‚";
                    document.getElementById("visit-count").textContent = user.visit_count;

                    // --- è³ªå•ä¸€è¦§ã‚’å–å¾— ---
                    const { data: questions } = await supabase
                        .from("questions")
                        .select("id, title, created_at, username")
                        .eq("user_email", user.user_email)
                        .order("created_at", { ascending: false });

                    const qList = document.getElementById("question-list");
                    questions?.forEach(q => {
                        const div = document.createElement("div");
                        div.classList.add("content-list-item");
                        const a = document.createElement("a");
                        a.href = `/mito1-website/question/details/?id=${q.id}`;
                        a.style.color = "inherit";
                        const title = document.createElement("h3");
                        title.textContent = q.title;
                        a.appendChild(title);
                        const time = document.createElement("p");
                        time.innerHTML = `<i class="fa-solid fa-clock"></i>${new Date(q.created_at).toLocaleString()}`;
                        a.appendChild(time);
                        const username = document.createElement("p");
                        username.innerHTML = `<i class="fa-solid fa-user"></i>${q.username}`;
                        a.appendChild(username);
                        div.appendChild(a);
                        qList.appendChild(div);
                    });

                    // --- æ²ç¤ºæ¿ã®æŠ•ç¨¿ä¸€è¦§ã‚’å–å¾— ---
                    const { data: threads } = await supabase
                        .from("BBS")
                        .select("id, thread, created_at, username, content")
                        .eq("user_email", user.user_email)
                        .order("created_at", { ascending: false });

                    const tList = document.getElementById("thread-list");
                    threads?.forEach(t => {
                        const div = document.createElement("div");
                        div.classList.add("content-list-item");
                        const a = document.createElement("a");
                        a.href = `/mito1-website/bbs/thread/?thread=${encodeURIComponent(t.thread)}&post_id=${encodeURIComponent(t.id)}`;
                        a.style.color = "inherit";
                        const title = document.createElement("h3");
                        const plainContent = t.content.split("<br>")[0].replace(/<[^>]*>/g, "");
                        title.textContent = plainContent.slice(0, 20) + (plainContent.length > 20 ? "..." : "");
                        a.appendChild(title);
                        const time = document.createElement("p");
                        time.innerHTML = `<i class="fa-solid fa-clock"></i>${new Date(t.created_at).toLocaleString()}`;
                        a.appendChild(time);
                        const username = document.createElement("p");
                        username.innerHTML = `<i class="fa-solid fa-user"></i>${t.username}`;
                        a.appendChild(username);
                        div.appendChild(a);
                        tList.appendChild(div);
                    });

                    // --- å›ç­”ä¸€è¦§ã‚’å–å¾— ---
                    const { data: answers } = await supabase
                        .from("answers")
                        .select("id, question_id, content, created_at, username")
                        .eq("user_email", user.user_email)
                        .order("created_at", { ascending: false });

                    const aList = document.getElementById("answer-list");
                    answers?.forEach(a => {
                        const div = document.createElement("div");
                        div.classList.add("content-list-item");
                        const aTag = document.createElement("a");
                        aTag.href = `/mito1-website/question/details/?id=${a.question_id}&answer_id=${a.id}`;
                        aTag.style.color = "inherit";
                        const content = document.createElement("h3");
                        content.textContent = a.content.slice(0, 20) + (a.content.length > 20 ? "..." : "");
                        aTag.appendChild(content);
                        const time = document.createElement("p");
                        time.innerHTML = `<i class="fa-solid fa-clock"></i>${new Date(a.created_at).toLocaleString()}`;
                        aTag.appendChild(time);
                        const username = document.createElement("p");
                        username.innerHTML = `<i class="fa-solid fa-user"></i>${a.username}`;
                        aTag.appendChild(username);
                        div.appendChild(aTag);
                        aList.appendChild(div);
                    });

                    document.getElementById('post-count').textContent = threads.length + questions.length + answers.length

                    isLoading = false;
                    document.getElementById('custom-alert').remove();

                    function textMosaic(str) {
                        return str.slice(0, 5) + "*".repeat(10) + str.slice(-5);
                    }
                }

            });
        }
    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>