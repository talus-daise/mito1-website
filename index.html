<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>トップぺージ | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="./notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="./img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="./img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="./img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="./img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="./script/customAlert.js" type="module"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!--マニフェスト-->
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <header>
        <h1>
            <a href="./">水戸一高附属中総合ウェブサイト</a>
        </h1>
    </header>
    <main>
        <section class="main__classlist">
            <h2>時間割</h2>
            <img src="" alt="時間割画像" id="timetable">
            <a href="timetable/">過去の時間割など</a>
            <hr>
            <p style="color: red;">もし、画像が表示されない場合は、一度<a
                    href="https://rebecka-unchilled-lisandra.ngrok-free.dev/">こちら</a>にアクセスして<code>Yes, I visit</code>を押してください。</p>
        </section>
        <section>
            <h2>サイト概要</h2>
            <p>水戸一高附属中生に向けた総合ウェブサイトです。主に掲示板や知恵袋サービスを運営しています。<br>更に使いやすいサイトになれるよう、頑張っていきますので、今後ともよろしくお願いします。</p>
        </section>
        <section class="highlight">
            <h2>スパムについて</h2>
            <p>このサイトではスパム行為を禁止しています。スパム行為が発覚した場合、サイトへのアクセスを制限させてもらうことがありますので、ご了承ください。</p>
            <p><s>あと普通に消すのめんどくさいからやめて</s></p>
        </section>
        <section>
            <h2>お問い合わせ</h2>
            <p><b>よくある質問は<a href="./faq.html">こちら</a>をご覧ください。</b></p>
            <p>
                サイトに関する要望があれば
                <a href="mailto:yamamoto.yuujirou@mito1-h.ibk.ed.jp?subject=ウェブサイトについての要望&body=要望の内容:%0D%0A%0D%0A不具合の報告の場合は以下の情報もご記入ください。%0D%0A- 使用端末（例: Windows PC, iPad, スマートフォンなど）%0D%0A- 使用ブラウザ（例: Chrome, Safari, Edgeなど）%0D%0A- 発生日時（例: 2025年2月28日 14:30頃）%0D%0A- スクリーンショットなどがあると尚良いです。%0D%0A- 不具合の詳細な説明:"
                    target="_blank" rel="noopener noreferrer">yamamoto.yuujirou@mito1-h.ibk.ed.jp</a>
                まで
            </p>
        </section>
    </main>

    <footer>
        <p>© 2025 talus</p>
        <p>※このサイトは学校非公認の個人が運営しているサイトです。学校側の問題に責任は取れませんのでご注意ください。</p>
        <p>
            <a href="https://www.mito1-jh.ibk.ed.jp" target="_blank" rel="noopener noreferrer">茨城県立水戸第一高等学校附属中学校HP</a>
        </p>
    </footer>

    <script>
        // 要素取得
        const imgEl = document.getElementById('timetable');

        // ファイル名パターン：年月日-時分秒-インデックス.jpg
        const FILENAME_RE = /(\d{6,8})-(\d{6})-(\d+)\.jpg$/i;

        /**
         * ファイル名から Date とインデックスを抽出
         */
        function parseFilename(filename) {
            const m = filename.match(FILENAME_RE);
            if (!m) return null;

            let [, datePart, timePart, indexPart] = m;
            if (datePart.length === 6) datePart = '20' + datePart; // YYMMDD → YYYYMMDD 補正

            const y = datePart.slice(0, 4);
            const mo = datePart.slice(4, 6);
            const d = datePart.slice(6, 8);
            const hh = timePart.slice(0, 2);
            const mm = timePart.slice(2, 4);
            const ss = timePart.slice(4, 6);

            const date = new Date(`${y}-${mo}-${d}T${hh}:${mm}:${ss}Z`);
            if (isNaN(date.getTime())) return null;

            return { date, index: Number(indexPart) };
        }

        /**
         * Basic認証＋ngrokスキップヘッダー付きfetch
         */
        function makeHeaders(user, pass) {
            const token = btoa(`${user}:${pass}`);
            return {
                Authorization: `Basic ${token}`,
                'ngrok-skip-browser-warning': 'true',
                'User-Agent': 'CustomClient/1.0',
            };
        }

        async function updateLatestImage(baseUrl = 'https://rebecka-unchilled-lisandra.ngrok-free.dev/') {
            const imgEl = document.getElementById('timetable');

            try {
                const res = await fetch(baseUrl, {
                    cache: 'no-store',
                    headers: makeHeaders('talus', 'talus'),
                });

                if (!res.ok) throw new Error(`一覧取得失敗: ${res.status}`);

                const text = await res.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const anchors = Array.from(doc.querySelectorAll('a[href]'));

                const candidates = anchors
                    .map(a => {
                        const href = a.getAttribute('href');
                        if (!href) return null;
                        const filename = href.split('/').pop();
                        const m = filename.match(FILENAME_RE);
                        if (!m) return null;
                        const [, datePartRaw, timePart, indexPart] = m;
                        const datePart = datePartRaw.length === 6 ? '20' + datePartRaw : datePartRaw;
                        const y = datePart.slice(0, 4);
                        const mo = datePart.slice(4, 6);
                        const d = datePart.slice(6, 8);
                        const hh = timePart.slice(0, 2);
                        const mm = timePart.slice(2, 4);
                        const ss = timePart.slice(4, 6);
                        const date = new Date(`${y}-${mo}-${d}T${hh}:${mm}:${ss}Z`);
                        return { url: new URL(href, baseUrl).href, filename, date, index: Number(indexPart) };
                    })
                    .filter(Boolean)
                    .sort((a, b) => b.date - a.date || b.index - a.index);

                if (candidates.length === 0) throw new Error('jpgファイルが見つかりませんでした。');

                const latest = candidates[0];
                const imgRes = await fetch(latest.url, { headers: makeHeaders('talus', 'talus') });
                if (!imgRes.ok) throw new Error(`画像取得失敗: ${imgRes.status}`);

                const blob = await imgRes.blob();
                imgEl.src = URL.createObjectURL(blob);
                imgEl.alt = latest.filename;

                // 親コンテナを作成（画像の見える範囲を制限）
                const wrapper = document.createElement('div');
                imgEl.parentNode.insertBefore(wrapper, imgEl);
                wrapper.appendChild(imgEl);

                // 親コンテナ側の設定（ここが表示範囲になる）
                wrapper.style.width = "calc(100% - 2rem)";      // 横の半分（=左上1/4用）
                wrapper.style.aspectRatio = "4 / 3"; // 4:3比率固定
                wrapper.style.overflow = "hidden";
                wrapper.style.position = "relative";
                wrapper.style.borderRadius = "8px";

                // 画像側の設定
                imgEl.style.width = "calc(200% + 20px)";
                imgEl.style.objectFit = "cover";
                imgEl.style.objectPosition = "left top";
                imgEl.style.display = "block";
                imgEl.style.cursor = "pointer";

                console.info('最新画像を更新:', latest.filename);

            } catch (err) {
                console.error('画像更新エラー:', err);
            }
        }

        // ページ読み込み時に1回実行
        updateLatestImage();

        // ★ クリックで全体表示する処理
        imgEl.addEventListener('click', () => {
            const fullView = document.createElement('div');
            fullView.style.position = 'fixed';
            fullView.style.top = 0;
            fullView.style.left = 0;
            fullView.style.width = '100vw';
            fullView.style.height = '100vh';
            fullView.style.backgroundColor = 'rgba(0,0,0,0.8)';
            fullView.style.display = 'flex';
            fullView.style.alignItems = 'center';
            fullView.style.justifyContent = 'center';
            fullView.style.zIndex = 9999;

            const img = document.createElement('img');
            img.src = imgEl.src;
            img.alt = imgEl.alt;
            img.style.maxWidth = '90vw';
            img.style.maxHeight = '90vh';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 0 20px rgba(0,0,0,0.5)';

            fullView.appendChild(img);
            document.body.appendChild(fullView);

            // クリックで閉じる
            fullView.addEventListener('click', () => {
                fullView.remove();
            });
        });
    </script>
    <script type="module" src="./notice/notice.js"></script>
    <script src="./script/customAlert.js" type="module"></script>
    <script src="./script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>