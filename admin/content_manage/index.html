<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>コンテンツ管理 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <link rel="stylesheet" href="../../script/contentManager/contentManager.css">
    <style>
        .content-list {
            display: grid;
            grid-template-columns: 100%;
            gap: 10px;
        }

        .content-item {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1>管理者用ページ</h1>
    </header>
    <main>
        <section>
            <h2>コンテンツ管理</h2>

            <h3>目次</h3>
            <a href="#question-list">質問一覧</a>
            <a href="#answer-list">回答一覧</a>
            <a href="#post-list">投稿一覧</a>

            <label for="search-box">検索：<input type="text" id="search-box" placeholder="コンテンツを検索..."></label>
            <button id="search-btn">検索</button>
            <hr>

            <div id="content-list" class="content-list">
                <div id="question-list" class="content-list">
                    <h3>質問一覧</h3>
                </div>
                <div id="answer-list" class="content-list">
                    <h3>回答一覧</h3>
                </div>
                <div id="post-list" class="content-list">
                    <h3>投稿一覧</h3>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        document.addEventListener("DOMContentLoaded", async () => {
            // 直前のページ（リファラ）が存在しない場合
            if (!document.referrer.includes("/mito1-website/admin/")) {
                window.location.href = "../"; // リダイレクト先
            }

            const { data: questions, error: questionError } = await supabase.from("questions").select("*").order("created_at", { ascending: false });
            const { data: answers, error: answerError } = await supabase.from("answers").select("*").order("created_at", { ascending: false });
            const { data: posts, error: postError } = await supabase.from("BBS").select("*").order("created_at", { ascending: false });

            if (questionError) {
                console.error("Error fetching questions:", questionError);
                return;
            }

            if (answerError) {
                console.error("Error fetching answers:", answerError);
                return;
            }

            if (postError) {
                console.error("Error fetching posts:", postError);
                return;
            }

            const questionList = document.getElementById("question-list");
            const answerList = document.getElementById("answer-list");
            const postList = document.getElementById("post-list");

            questions.forEach(question => {
                const questionItem = document.createElement("div");
                questionItem.className = "content-item";
                questionItem.innerHTML = `
                    <strong>ID: </strong><span>${question.id}</span><br>
                    <strong>作成者: </strong><span>${question.username}</span><br>
                    <strong>タイトル: </strong><span>${question.title}</span><br>
                    <strong>内容: </strong><span>${question.content}</span><br>
                    <strong>作成日時: </strong><span>${question.created_at}</span><br>
                    <button data-question-id="${question.id}" class="edit-entry" style="width: fit-content;">質問編集</button>
                    <button data-question-id="${question.id}" class="delete-entry" style="width: fit-content;">質問削除</button>
                    <button data-question-id="${question.id}" class="view-entry" style="width: fit-content;">質問表示</button>
                `;
                questionList.appendChild(questionItem);
            });

            answers.forEach(answer => {
                const answerItem = document.createElement("div");
                answerItem.className = "content-item";
                answerItem.innerHTML = `
                    <strong>ID: </strong><span>${answer.id}</span><br>
                    <strong>作成者: </strong><span>${answer.username}</span><br>
                    <strong>質問ID: </strong><span>${answer.question_id}</span><br>
                    <strong>内容: </strong><span>${answer.content}</span><br>
                    <strong>作成日時: </strong><span>${answer.created_at}</span><br>
                    <button data-answer-id="${answer.id}" class="edit-entry" style="width: fit-content;">回答編集</button>
                    <button data-answer-id="${answer.id}" class="delete-entry" style="width: fit-content;">回答削除</button>
                    <button data-answer-id="${answer.id}" class="view-entry" style="width: fit-content;">回答表示</button>
                `;
                answerList.appendChild(answerItem);
            });

            posts.forEach(post => {
                const postItem = document.createElement("div");
                postItem.className = "content-item";
                postItem.innerHTML = `
                    <strong>ID: </strong><span>${post.id}</span><br>
                    <strong>作成者: </strong><span>${post.username}</span><br>
                    <strong>タイトル: </strong><span>${post.title}</span><br>
                    <strong>内容: </strong><span>${post.content}</span><br>
                    <strong>作成日時: </strong><span>${post.created_at}</span><br>
                    <button data-post-id="${post.id}" class="edit-entry" style="width: fit-content;">投稿編集</button>
                    <button data-post-id="${post.id}" class="delete-entry" style="width: fit-content;">投稿削除</button>
                    <button data-post-id="${post.id}" class="view-entry" style="width: fit-content;">投稿表示</button>
                `;
                postList.appendChild(postItem);
            });

            function enableEdit(card) {
                if (card.classList.contains("editing")) {
                    card.classList.remove("editing")
                    card.style.border = "1px solid #ccc";
                    card.querySelectorAll(":not(strong)").forEach(text => {
                        text.contentEditable = false;
                    });
                    return;
                }; // すでに編集モードの場合は無視
                card.classList.add("editing");
                card.style.border = "2px solid #4a90e2";
                card.querySelectorAll(":not(strong)").forEach(text => {
                    if (text.previousElementSibling && text.previousElementSibling.textContent.includes("ID" || "作成日時")) return; // 作成日時は編集不可
                    text.contentEditable = true;
                });
            }

            document.querySelectorAll(".edit-entry").forEach(button => {
                button.addEventListener("click", (event) => {
                    event.stopPropagation();
                    event.preventDefault();
                    enableEdit(event.target.closest(".content-item"));
                });
            });

            document.querySelectorAll(".delete-entry").forEach(button => {
                button.addEventListener("click", async (event) => {
                    event.stopPropagation();
                    const id = button.getAttribute("data-question-id") || button.getAttribute("data-answer-id") || button.getAttribute("data-post-id");
                    let type = "";
                    if (button.hasAttribute("data-question-id")) type = "questions";
                    else if (button.hasAttribute("data-answer-id")) type = "answers";
                    else if (button.hasAttribute("data-post-id")) type = "BBS";

                    if (confirm("本当に削除しますか？この操作は元に戻せません。")) {
                        const { error } = await supabase.from(type).delete().eq("id", id);
                        if (error) {
                            showCustomAlert("削除中にエラーが発生しました。");
                            console.error("削除エラー:", error);
                        } else {
                            showCustomAlert("コンテンツを削除しました。");
                            location.reload();
                        }
                    }
                });
            });

            document.querySelectorAll(".view-entry").forEach(button => {
                button.addEventListener("click", (event) => {
                    event.stopPropagation();
                    const id = button.getAttribute("data-question-id") || button.getAttribute("data-answer-id") || button.getAttribute("data-post-id");
                    let type = "";
                    if (button.hasAttribute("data-question-id")) type = "question";
                    else if (button.hasAttribute("data-answer-id")) type = "answer";
                    else if (button.hasAttribute("data-post-id")) type = "post";

                    if (type === "question") {
                        window.location.href = `../../question/details/?id=${id}`;
                    } else if (type === "answer") {
                        // 回答の場合、関連する質問ページへリダイレクト
                        supabase.from("answers").select("question_id").eq("id", id).then(({ data, error }) => {
                            if (error) {
                                showCustomAlert("エラーが発生しました。");
                                console.error("取得エラー:", error);
                            } else if (data.length > 0) {
                                window.location.href = `../../question/details/?id=${data[0].question_id}`;
                            }
                        });
                    } else if (type === "post") {
                        supabase.from("BBS").select("thread").eq("id", id).then(({ data, error }) => {
                            if (error) {
                                showCustomAlert("エラーが発生しました。");
                                console.error("取得エラー:", error);
                            } else if (data.length > 0) {
                                window.location.href = `../../bbs/thread/?thread=${encodeURIComponent(data[0].thread)}`;
                            }
                        });
                    }
                });
            });
        });

        document.getElementById("search-btn").addEventListener("click", filterContents);
        function filterContents() {
            const keyword = document.getElementById("search-box").value.toLowerCase();
            const contentItems = document.querySelectorAll(".content-item");

            contentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(keyword)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        }

        document.getElementById("search-box").addEventListener("keydown", (event) => {
            if (event.key === "Enter" && document.activeElement === document.getElementById("search-box")) {
                filterContents();
            }
        });
    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script type="module" src="../../script/contentManager/contentManager.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script src="../../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>