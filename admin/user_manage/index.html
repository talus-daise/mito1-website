<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>ユーザー管理 | 管理者用ページ</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <style>
        .content-list-item {
            position: relative;
        }

        .user-actions-menu-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
            z-index: 2;
            box-shadow: none;
        }

        .user-actions-menu-btn:hover {
            color: #333;
            box-shadow: none;
        }

        .user-actions-menu-btn:active {
            background-color: transparent;
            color: #FE483B;
        }

        .user-actions-menu {
            display: none;
            position: absolute;
            top: 40px;
            right: 10px;
            border-radius: 6px;
            min-width: 120px;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .user-actions-menu.active {
            display: block;
        }

        .user-actions-menu button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 8px 12px;
            background: none;
            border: none;
            color: #333;
            font-size: 1rem;
            cursor: pointer;
            gap: 8px;
            margin: 0;
            border-radius: 0;
            background-color: #eee;
            box-shadow: none;
        }

        .user-actions-menu button:hover {
            background: #999;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/" type="module"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1>管理者用ページ</h1>
    </header>
    <main>
        <section>
            <h2>ユーザー管理</h2>
            <div id="user-list" class="content-list"></div>
        </section>
    </main>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        document.addEventListener("DOMContentLoaded", async () => {
            // 直前のページ（リファラ）が存在しない場合
            if (!document.referrer.includes("/mito1-website/admin/")) {
                window.location.href = "../"; // リダイレクト先
            }

            const { data, error } = await supabase.from("users").select("*").order("full_name", { ascending: true });

            if (error) {
                console.error("Error fetching users:", error);
                return;
            }
            const userList = document.getElementById("user-list");

            if (data.length === 0) {
                userList.innerHTML = "<p>ユーザーが見つかりません。</p>";
                return;
            }

            data.filter(user => user.full_name).forEach(user => {
                const userItem = document.createElement("div");
                userItem.className = "content-list-item";
                userItem.innerHTML = `
                    <button class="user-actions-menu-btn" title="操作メニュー" tabindex="0">︙</button>
                    <div class="user-actions-menu">
                        <button class="user-actions-menu-close-btn" title="名前変更" tabindex="0">
                            <i class="fa-solid fa-pencil"></i> 名前変更
                        </button>
                        <button class="stop-user-btn" data-user-id="${user.user_id}" title="ユーザー停止">
                            <i class="fa-solid fa-ban"></i> 停止
                        </button>
                        <button class="delete-user-btn" data-user-id="${user.user_id}" title="ユーザー削除">
                            <i class="fa-solid fa-trash"></i> 削除
                        </button>
                        <button class="redirect-user-page-btn" data-user-id="${user.user_id}" title="ユーザー詳細">
                            <i class="fa-solid fa-arrow-up-right-from-square"></i> 詳細
                        </button>
                    </div>
                    <p><i class="fa-solid fa-id-card"></i> ${user.user_id}</p>
                    <p><i class="fa-solid fa-school"></i> ${user.full_name}</p>
                    <p><i class="fa-solid fa-envelope"></i> ${user.user_email}</p>
                    <p><i class="fa-solid fa-user"></i> ${user.display_name}</p>
                    <p><i class="fa-solid fa-user-tag"></i> ${user.role === null ? "visitor" : user.role}</p>
                `;

                // メニュー開閉制御
                const menuBtn = userItem.querySelector(".user-actions-menu-btn");
                const menu = userItem.querySelector(".user-actions-menu");
                menuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    // すでにこのメニューが開いている場合は閉じる
                    if (menu.classList.contains("active")) {
                        menu.classList.remove("active");
                        return;
                    }
                    // 他のメニューを閉じる
                    document.querySelectorAll('.user-actions-menu.active').forEach(m => m.classList.remove('active'));
                    menu.classList.add("active");
                });
                // 外側クリックで閉じる
                document.addEventListener("click", () => {
                    menu.classList.remove("active");
                });
                // メニュー内クリックは閉じない
                menu.addEventListener("click", e => e.stopPropagation());

                // ボタンイベント登録
                const nameChangeBtn = userItem.querySelector(".user-actions-menu-close-btn");
                nameChangeBtn.addEventListener("click", async () => {
                    let newName = prompt("新しい名前を入力してください。", user.display_name);

                    if (newName === null) {
                        showCustomNotification("名前変更をキャンセルしました。");
                        return; // キャンセルされた場合
                    }

                    if (newName.trim() === "") {
                        newName = "とある水戸一の名無し"; // デフォルト名
                    }

                    const { error: updateError } = await supabase
                        .from("users")
                        .update({ display_name: newName.trim() })
                        .eq("user_id", user.user_id);

                    await Promise.all([
                        supabase.from("BBS").update({ username: newName.trim() }).eq("user_id", user.user_id),
                        supabase.from("questions").update({ username: newName.trim() }).eq("user_id", user.user_id),
                        supabase.from("answers").update({ username: newName.trim() }).eq("user_id", user.user_id)
                    ]);

                    if (updateError) {
                        console.error("Error updating name:", updateError);
                        return;
                    }
                    showCustomNotification("名前を変更しました。");
                    menu.classList.remove("active");
                });

                const stopBtn = userItem.querySelector(".stop-user-btn");
                stopBtn.addEventListener("click", async () => {
                    const is_stopped = user.is_stopped ? "停止解除" : "停止";
                    const confirmation = confirm(`本当にこのユーザーを${is_stopped}しますか？`);
                    if (!confirmation) {
                        return;
                    }

                    const userId = stopBtn.getAttribute("data-user-id");
                    const { error: stopError } = await supabase
                        .from("users")
                        .update({ is_stopped: !user.is_stopped })
                        .eq("user_id", userId);
                    if (stopError) {
                        console.error("Error stopping user:", stopError);
                        return;
                    }
                    showCustomNotification(`ユーザーを${is_stopped}しました。`);
                    menu.classList.remove("active");
                });

                const deleteBtn = userItem.querySelector(".delete-user-btn");
                deleteBtn.addEventListener("click", async () => {
                    const confirmation = confirm("本当にこのユーザーを削除しますか？この操作は元に戻せません。");
                    if (!confirmation) {
                        showCustomNotification("ユーザー削除をキャンセルしました。");
                        return;
                    }
                    const userId = deleteBtn.getAttribute("data-user-id");
                    const { error: deleteError } = await supabase
                        .from("users")
                        .delete()
                        .eq("user_id", userId);

                    if (deleteError) {
                        console.error("Error deleting user:", deleteError);
                        return;
                    }

                    userItem.remove();

                    showCustomNotification("ユーザーを削除しました。");
                });

                const redirectBtn = userItem.querySelector(".redirect-user-page-btn");
                redirectBtn.addEventListener("click", () => {
                    const userId = redirectBtn.getAttribute("data-user-id");
                    window.location.href = `/mito1-website/mypage/other/?user_id=${encodeURIComponent(userId)}&redirect_url=/mito1-website/admin/`;
                });

                userList.appendChild(userItem);
            });
        });
    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>