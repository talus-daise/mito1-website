<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>リクエスト曲管理 | 管理者用ページ</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <style>
        .content-list {
            display: grid;
            grid-template-columns: calc(200px * 6 + 2rem);
            gap: 10px;
            overflow-x: auto;
        }

        .content-item {
            display: grid;
            grid-template-columns: 2rem repeat(auto-fill, minmax(200px, 1fr));
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            gap: 10px;
        }

        .content-item input[type="checkbox"] {
            height: 1rem;
            margin-top: 5px;
            background: transparent;
        }

        .content-item button {
            height: 1.5rem;
        }

        .content-item a {
            padding: 0.5rem 1rem;
        }

        .table-header {
            display: block;
            font-weight: bold;
            padding-bottom: 5px;
            text-align: left;
            width: auto;
            border-radius: 5px;
            user-select: none;
        }

        .table-header:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/" type="module"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1>管理者用ページ</h1>
    </header>
    <main>
        <section>
            <h2>リクエスト曲管理</h2>

            <label for="search-box">検索：<input type="text" id="search-box" placeholder="リクエスト曲を検索..."></label>
            <button id="search-btn">検索</button>
            <div class="content-list" id="request-music-list">
                <div class="content-item">
                    <p class="table-header"><strong>I/O</strong></p>
                    <p class="table-header" id="sort-by-songname"><strong>曲名</strong></p>
                    <p class="table-header" id="sort-by-date"><strong>リクエスト日時</strong></p>
                    <p class="table-header" id="sort-by-studentid"><strong>学籍番号</strong></p>
                    <p class="table-header"><strong>動画リンク</strong></p>
                    <p class="table-header"><strong>操作</strong></p>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        let is_allowed = false;

        document.addEventListener("DOMContentLoaded", async () => {
            const ALLOWED_ROLES = ["master", "admin", "request_music_manager"];

            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                location.replace("/mito1-website/");
                return;
            }

            const { data, error } = await supabase
                .from("users")
                .select("role")
                .eq("user_id", user.id)
                .single();

            if (error || !ALLOWED_ROLES.includes(data.role)) {
                location.replace("/mito1-website/");
                return;
            }
            // 直前のページ（リファラ）が存在しない場合
            if (!document.referrer.includes("/mito1-website/admin/")) {
                window.location.href = "../"; // リダイレクト先
            }

            // リクエスト曲一覧の取得と表示
            const listContainer = document.getElementById("request-music-list");
            try {
                const { data: musicRequests, error } = await supabase
                    .from("request-music")
                    .select("*")
                    .order("created_at", { ascending: false });
                if (error) throw error;

                // 取得したリクエスト曲を表示
                musicRequests.forEach(request => {
                    const item = document.createElement("div");
                    item.className = "content-item";

                    const isPlayed = document.createElement("input");
                    isPlayed.type = "checkbox";
                    isPlayed.checked = request.isplayed;
                    isPlayed.addEventListener("change", async () => {
                        const { error: updateError } = await supabase
                            .from("request-music")
                            .update({ isplayed: isPlayed.checked })
                            .eq("id", request.id);
                        if (updateError) {
                            showCustomNotification("更新中にエラーが発生しました。");
                            console.error("更新エラー:", updateError);
                            isPlayed.checked = !isPlayed.checked; // 元に戻す
                        } else {
                            showCustomNotification("再生状況を更新しました。");
                        }
                    });

                    const title = document.createElement("p");
                    title.insertAdjacentHTML("beforeend", `${request.musicName}`);

                    const date = document.createElement("p");
                    date.insertAdjacentHTML("beforeend", `${new Date(request.created_at).toLocaleString().slice(0, 10)}`);

                    const studentId = document.createElement("p");
                    studentId.insertAdjacentHTML("beforeend", `${request.studentId}`);

                    const videoLink = document.createElement("a");
                    videoLink.href = request.url;
                    videoLink.target = "_blank";
                    videoLink.rel = "noopener noreferrer";
                    videoLink.textContent = "動画リンク";

                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "削除";
                    deleteButton.addEventListener("click", async () => {
                        const { error: deleteError } = await supabase
                            .from("request-music")
                            .delete()
                            .eq("id", request.id);
                        if (deleteError) {
                            showCustomNotification("削除中にエラーが発生しました。");
                            console.error("削除エラー:", deleteError);
                        } else {
                            showCustomNotification("リクエストを削除しました。");
                            item.remove();
                        }
                    });
                    item.appendChild(isPlayed);
                    item.appendChild(title);
                    item.appendChild(date);
                    item.appendChild(studentId);
                    item.appendChild(videoLink);
                    item.appendChild(deleteButton);
                    listContainer.appendChild(item);
                });
            } catch (error) {
                console.error("Error fetching music requests:", error);
            }
        });

        const searchBox = document.getElementById("search-box");
        const searchBtn = document.getElementById("search-btn");

        searchBtn.addEventListener("click", () => {
            const query = searchBox.value.trim().toLowerCase();
            const items = document.querySelectorAll(".content-item:not(:first-child)");
            Array.from(items).forEach(item => {
                const title = item.textContent.toLowerCase();
                item.style.display = title.includes(query) ? "grid" : "none";
            });
        });

        searchBox.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                searchBtn.click();
            }
        });

        // 昇順・降順の状態を列ごとに記録
        const sortState = {
            1: "normal",
            2: "normal",
            3: "normal"
        };

        document.getElementById("sort-by-songname").addEventListener("click", () => {
            sortContentList(1);
        });
        document.getElementById("sort-by-date").addEventListener("click", () => {
            sortContentList(2);
        });
        document.getElementById("sort-by-studentid").addEventListener("click", () => {
            sortContentList(3);
        });

        function sortContentList(columnIndex) {
            const listContainer = document.getElementById("request-music-list");

            // 順序のトグル
            const current = sortState[columnIndex];
            const next = current === "asc" ? "desc" : "asc";
            for (const key in sortState) {
                if (key != columnIndex) sortState[key] = "normal";
            }
            const allTitle = listContainer.querySelectorAll(".table-header strong");
            allTitle.forEach(title => {
                title.textContent = title.textContent.replace(/ ▲| ▼/, "");
            });
            const title = listContainer.querySelector(`.table-header:nth-child(${columnIndex + 1}) strong`);
            title.textContent += next === "asc" ? " ▲" : " ▼";
            sortState[columnIndex] = next;

            const items = Array.from(listContainer.getElementsByClassName("content-item")).slice(1);

            const sortedItems = items.sort((a, b) => {
                let aText = a.children[columnIndex].textContent.trim();
                let bText = b.children[columnIndex].textContent.trim();

                if (columnIndex === 2) {
                    const result = new Date(aText) - new Date(bText);
                    return next === "asc" ? result : -result;
                } else {
                    const result = aText.localeCompare(bText);
                    return next === "asc" ? result : -result;
                }
            });

            sortedItems.forEach(item => listContainer.appendChild(item));
        }
    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>