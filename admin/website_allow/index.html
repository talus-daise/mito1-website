<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>ウェブサイト許可管理 | 水戸一高附属中総合ウェブサイト</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <style>
        .content-list {
            display: grid;
            grid-template-columns: 100%;
            gap: 10px;
        }

        .content-item {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1>管理者用ページ</h1>
    </header>
    <main>
        <section>
            <h2>ウェブサイト許可管理</h2>

            <h3>現在のサイトアクセス許可状況</h3>
            <p><span id="current-status">読み込み中...</span></p>
            <button id="toggle-button">許可/不許可</button>

            <h3>今日の曜日</h3>
            <p id="current-day">読み込み中...</p>
        </section>
    </main>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        let is_allowed = false;

        const statusSpan = document.getElementById("current-status");

        document.addEventListener("DOMContentLoaded", async () => {
            // 直前のページ（リファラ）が存在しない場合
            if (!document.referrer.includes("/mito1-website/admin/")) {
                window.location.href = "../"; // リダイレクト先
            }

            const startOfDay = new Date();
            startOfDay.setHours(0, 0, 0, 0);

            const endOfDay = new Date();
            endOfDay.setHours(23, 59, 59, 999);

            const { data, error } = await supabase
                .from("website_allow")
                .select("*")
                .gte("created_at", startOfDay.toISOString()) // 当日00:00:00以降
                .lt("created_at", endOfDay.toISOString())    // 当日23:59:59以前
                .single();

            if (error || !data) {
                console.warn("No data found or error occurred:", error);
                statusSpan.textContent = "不許可";
                statusSpan.style.color = "red";
                is_allowed = false;
            }

            if (error) {
                console.error("Error fetching website allow status:", error);
                statusSpan.textContent = "エラーが発生しました。";
            }

            if (data && data.is_allow) {
                statusSpan.textContent = "許可";
                statusSpan.style.color = "green";
                is_allowed = true;
            } else {
                statusSpan.textContent = "不許可";
                statusSpan.style.color = "red";
                is_allowed = false;
            }

            document.getElementById("toggle-button").addEventListener("click", async () => {
                const newStatus = !is_allowed;

                if (data) {
                    const { error: updateError } = await supabase
                        .from("website_allow")
                        .update({ is_allow: newStatus })
                        .eq("id", data.id);

                    if (updateError) {
                        console.error("Error updating website allow status:", updateError);
                        showCustomAlert("ステータスの更新中にエラーが発生しました。");
                        return;
                    }
                } else {
                    const { error: insertError } = await supabase
                        .from("website_allow")
                        .insert([{ is_allow: newStatus }]);

                    if (insertError) {
                        console.error("Error inserting new website allow status:", insertError);
                        showCustomAlert("ステータスの挿入中にエラーが発生しました。");
                        return;
                    }
                }

                if (newStatus) {
                    statusSpan.textContent = "許可";
                    statusSpan.style.color = "green";
                    is_allowed = true;
                } else {
                    statusSpan.textContent = "不許可";
                    statusSpan.style.color = "red";
                    is_allowed = false;
                }

                showCustomAlert("ステータスが更新されました。");
            });

            const days = ["日曜日", "月曜日", "火曜日", "水曜日", "木曜日", "金曜日", "土曜日"];
            const today = new Date();
            document.getElementById("current-day").textContent = days[today.getDay()];
        });

    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script src="../../script/verification.js"></script>
    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>