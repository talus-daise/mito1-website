<!DOCTYPE html>
<html lang="ja">

<head>
    <!--文字コード・互換モード-->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
    <title>ウェブサイト許可管理 | 管理者用ページ</title>
    <!--ビューポート-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--css-->
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css">
    <link rel="stylesheet" href="../../script/notice/notice.css">
    <!--web情報-->
    <meta name="keywords" content="水戸一, 水戸一附属, 水戸一附属中, 一学年,">
    <meta name="description" content="水戸一附属中生向けの総合ウェブサイトです。附属中向けの掲示板や質問箱を運営しています。">
    <meta name="author" content="©️ 2025 talus">
    <!--更新日時-->
    <meta name="date" content="2025-02-28">
    <meta name="creation_date" content="2025-02-19">
    <!--URL-->
    <link rel="canonical" href="https://talus-yujiro.github.io/mito1-website/">
    <!--アイコン-->
    <link rel="shortcut icon" href="../../img/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="../../img/mitoichi-fuzoku-180x180.png" sizes="180x180">
    <!--windows-->
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-TileImage" content="../../img/mitoichi-fuzoku.png">
    <!--safari-->
    <link rel="mask-icon" href="">
    <!--Android-->
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" href="../../img/mitoichi-fuzoku-192x192.png" sizes="192x192">
    <!--CDN-->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.35.4"></script>
    <script src="../../script/" type="module"></script>
    <!--マニフェスト-->
    <link rel="manifest" href="../../manifest.json">
</head>

<body>
    <header>
        <h1>管理者用ページ</h1>
    </header>

    <main>
        <h1>ウェブサイト許可管理</h1>

        <section>
            <h2>現在の全体ステータス</h2>
            <p id="current-status">読み込み中...</p>
        </section>

        <section>
            <h2>制限ルール追加</h2>

            <p>
                <label>
                    ラベル
                    <input id="label" type="text" placeholder="例：平日昼制限">
                </label><br>
            </p>

            <p>
                <label>
                    開始日時
                    <input id="start-time" type="datetime-local">
                </label><br>
            </p>

            <p>
                <label>
                    終了日時
                    <input id="end-time" type="datetime-local">
                </label><br>
            </p>

            <p>
                <label>
                    モード
                    <select id="mode">
                        <option value="restrict">制限</option>
                        <option value="allow">制限解除</option>
                    </select>
                </label>
            </p>

            <p><button id="add-rule">追加</button></p>
        </section>

        <section>
            <h2>現在有効な制限</h2>
            <div id="active-rules" class="content-list"></div>
        </section>
    </main>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const supabase = createClient(
            "https://mgsbwkidyxmicbacqeeh.supabase.co",
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nc2J3a2lkeXhtaWNiYWNxZWVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDA0MjIsImV4cCI6MjA1NTUxNjQyMn0.fNkFQykD9ezBirtJM_fOB7XEIlGU1ZFoejCgrYObElg"
        );

        /* ===== 平日固定制限判定 ===== */
        function isFixedRestricted() {
            const now = new Date();
            const day = now.getDay(); // 0=日,6=土
            if (day === 0 || day === 6) return false;

            const m = now.getHours() * 60 + now.getMinutes();
            return (
                (m >= 8 * 60 + 25 && m <= 11 * 60 + 30) ||
                (m >= 13 * 60 + 5 && m <= 15 * 60 + 55)
            );
        }

        document.addEventListener("DOMContentLoaded", async () => {
            const ALLOWED_ROLES = ["master", "admin", "manager"];

            const { data: { user } } = await supabase.auth.getUser();

            if (!user) {
                location.replace("/mito1-website/");
                return;
            }

            const { data, error } = await supabase
                .from("users")
                .select("role")
                .eq("user_id", user.id)
                .single();

            if (error || !ALLOWED_ROLES.includes(data.role)) {
                location.replace("/mito1-website/");
                return;
            }

            const statusEl = document.getElementById("current-status");
            const listEl = document.getElementById("active-rules");

            async function refresh() {
                const nowUtc = Date.now();

                const { data, error } = await supabase
                    .from("website_restrictions")
                    .select("*");

                if (error) {
                    statusEl.textContent = "エラー";
                    return;
                }

                const active = data.filter(r => {
                    const start = new Date(r.start_time).getTime();
                    const end = new Date(r.end_time).getTime();
                    return start <= nowUtc && nowUtc <= end;
                });

                listEl.innerHTML = "";

                if (active.length === 0) {
                    listEl.innerHTML = "<p>現在有効な制限はありません</p>";
                }

                active.forEach(r => {
                    const div = document.createElement("div");
                    div.classList.add("content-list-item");

                    div.innerHTML = `
                <h3>${r.label}</h3>
                <p><i class="fa-solid fa-clock"></i>
                ${new Date(r.start_time).toLocaleString("ja-JP")} 〜
                ${new Date(r.end_time).toLocaleString("ja-JP")}</p>
                <p><i class="fa-solid fa-tag"></i>${r.mode}</p>
            `;
                    listEl.appendChild(div);
                });

                const hasAllow = active.some(r => r.mode === "allow");
                const hasRestrict = active.some(r => r.mode === "restrict");
                const fixedRestricted = isFixedRestricted();

                /* ===== 許可最優先 ===== */
                if (hasAllow) {
                    statusEl.textContent = "許可（allow）";
                    statusEl.style.color = "lightgreen";
                } else if (fixedRestricted || hasRestrict) {
                    statusEl.textContent = "不許可（restrict）";
                    statusEl.style.color = "red";
                } else {
                    statusEl.textContent = "許可（default）";
                    statusEl.style.color = "lightgreen";
                }
            }

            document.getElementById("add-rule").addEventListener("click", async () => {
                const label = document.getElementById("label").value;
                const start = document.getElementById("start-time").value;
                const end = document.getElementById("end-time").value;
                const mode = document.getElementById("mode").value;

                if (!label || !start || !end) return;

                // JSTとして保存
                function toJstIso(str) {
                    // str: "YYYY-MM-DDTHH:mm"
                    return str + ":00+09:00";
                }

                await supabase.from("website_restrictions").insert([{
                    label,
                    start_time: toJstIso(start),
                    end_time: toJstIso(end),
                    mode
                }]);

                document.getElementById("label").value = "";
                refresh();
            });

            refresh();
            setInterval(refresh, 60000);
        });
    </script>
    <script type="module" src="../../script/notice/notice.js"></script>
    <script src="../../script/customAlert.js" type="module"></script>
    <script type="module" src="../../script/restriction.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script type="module" src="../../script/notification.js"></script>
    <script src="../../script/verification.js" type="module"></script>

    <script data-goatcounter="https://talus.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>